/**
 * AgoraWebSDK_N-v4.23.2-1-0-g7fdaa39d-dirty Copyright AgoraInc.
 */

import{LocalAudioTrack as e,LocalVideoTrack as t,getCompatibility as i,TrackHint as s,audioTimerLoop as n,MixingAudioTrack as o,DEFAULT_LOCAL_AUDIO_TRACK_STATS as r,DEFAULT_LOCAL_VIDEO_TRACK_STATS as a,DEFAULT_REMOTE_AUDIO_TRACK_STATS as c,DEFAULT_REMOTE_VIDEO_TRACK_STATS as d,DEFAULT_NETWORK_QUALITY_STATS as l,MediaElementNumStatus as h,visibilityWatcher as u,MediaElementStatus as p,audioElementPlayCenter as E,MicrophoneAudioTrack as _,CameraVideoTrack as S,getOriginSenderConfig as m,RemoteAudioTrack as R,RemoteVideoTrack as T,TrackInternalEvent as C,RemoteTrackEvents as f,TrackEvents as A,StreamType as I}from"@agora-js/media";import{logger as v,AgoraRTCError as g,report as D,AgoraRTCEvent as N,AgoraRTCEventUploadType as L}from"@agora-js/report";import{IS_GLOBAL_VERSION as P,EventEmitter as O,getParameter as w,ScalabilityMode as b,parseSdp as y,isFirefox as M,jsonClone as k,printSdp as U,getRandomString as x,getBrowserInfo as V,BrowserName as F,BrowserOS as B,PromiseMutex as G,createWebRTCStatsFilter as W,AgoraRTCError as H,AgoraRTCErrorCode as K,P2PTransportType as Y,DEFAULT_CANDIDATE_STATS as q,isRTCIceServerList as j,isChromeKernel as J,PeerConnectionState as X,isSafari as z,isChromeBelow90 as Q,isChrome as Z,isBelowIOS14_6 as $,VideoCodec as ee,QualityLimitationReason as te,OVERUSE_DETECTOR_PARAMS as ie,isAboveIOS as se,isBelowIOS as ne,isAboveSafari as oe,isBelowSafari as re,emitAsPromiseNoResponse as ae,emitAsPromise as ce,emitAsInvokerNoResponse as de,getUniqueList as le,wait as he,AgoraAPITag as ue,getRetryWaitTime as pe,DEFAULT_RETRY_CONFIG as Ee,uint8ArrayToBase64 as _e,createDefer as Se,isMacOS as me,NETWORK_STATE as Re,networkIndicator as Te,NETWORK_INDICATOR_EVENTS as Ce,Rolling as fe,ConnectionDisconnectedReason as Ae,WebSocketQuitReason as Ie,base64ToUint8Array as ve}from"@agora-js/shared";function ge(e,t){this.v=e,this.k=t}function De(e,t,i,s,n){var o={};return Object.keys(s).forEach((function(e){o[e]=s[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer?(Object.defineProperty(e,t,o),null):o}function Ne(e){return new ge(e,0)}function Le(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Pe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function Oe(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Pe(Object(i),!0).forEach((function(t){Le(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Pe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function we(e){return function(){return new be(e.apply(this,arguments))}}function be(e){var t,i;function s(t,i){try{var o=e[t](i),r=o.value,a=r instanceof ge;Promise.resolve(a?r.v:r).then((function(i){if(a){var c="return"===t?"return":"next";if(!r.k||i.done)return s(c,i);i=e[c](i).value}n(o.done?"return":"normal",i)}),(function(e){s("throw",e)}))}catch(e){n("throw",e)}}function n(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?s(t.key,t.arg):i=null}this._invoke=function(e,n){return new Promise((function(o,r){var a={key:e,arg:n,resolve:o,reject:r,next:null};i?i=i.next=a:(t=i=a,s(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}be.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},be.prototype.next=function(e){return this._invoke("next",e)},be.prototype.throw=function(e){return this._invoke("throw",e)},be.prototype.return=function(e){return this._invoke("return",e)};let ye=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),Me=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),ke=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),Ue=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),xe=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),Ve=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),Fe=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e}({}),Be=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),Ge=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),We=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),He=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),Ke=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({}),Ye=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),qe=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({});const je=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]];let Je=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});Je.AFRICA,Je.ASIA,Je.CHINA,Je.EUROPE,Je.GLOBAL,Je.INDIA,Je.JAPAN,Je.NORTH_AMERICA,Je.OCEANIA,Je.OVERSEA,Je.SOUTH_AMERICA;let Xe=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});Xe.ASIA,Xe.NORTH_AMERICA,Xe.EUROPE,Xe.JAPAN,Xe.INDIA,Xe.KOREA,Xe.HKMC,Xe.US,Xe.OVERSEA,Xe.GLOBAL,Xe.OCEANIA,Xe.SOUTH_AMERICA,Xe.AFRICA,P&&Xe.CHINA;class ze extends O{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.onICECandidateError=void 0,this.getLocalVideoStats=void 0}}class Qe extends ze{constructor(e,t){super(e,t),this.establishPromise=void 0}}let Ze=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),$e=function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e}({}),et=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),tt=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),it=function(e){return e.AudioMetadata="audioMetadata",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),st=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),nt=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),ot=function(e){return e.ABORT="abort",e}({}),rt=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),at=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});function ct(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(w("TURN_DOMAIN")):(v.debug("Cannot recognized as ip address: ".concat(e,", use as host")),e)}function dt(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function lt(e,t){const i=t.getMediaStreamTrack(!0).getSettings(),s=t.videoHeight||i.height,n=t.videoWidth||i.width;return s&&n?Math.max(Math.min(s,n)/Math.min(dt(e.height),dt(e.width)),1):(v.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ht(e){let{candidateType:t,relayProtocol:i,type:s,address:n,port:o,protocol:r}=e;const a={candidateType:t,relayProtocol:i,protocol:r};if("local-candidate"!==s){const e=n.split(".");e.length>=4&&(e[1]="*",e[2]="*"),a.address=e.join("."),a.port=o}return a}function ut(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:w("SVC_MODE");if(w("ENABLE_SVC"))return function(e){return e in b}(e)?e:b.L1T3}const pt={[Ze.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[Ze.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function Et(e,t,i){t.forEach((t=>{const s=pt[e].find((e=>{let{key:i}=e;return t.extensionName.includes(i)}));if(!s)return;const n=i.find((e=>{let{extensionName:t}=e;return t.includes(s.key)}));n&&n.extensionName.includes("gdpr_forbidden")&&(t.extensionName=n.extensionName)}))}function _t(e,t){t.forEach((t=>{const i=pt[e].find((e=>{let{key:i}=e;return t.extensionName.includes(i)}));t.extensionName.includes("gdpr_forbidden")&&i&&(t.extensionName=i.extensionName)}))}function St(e){return"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e||e.includes("abs-send-time")}function mt(e){return"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e||e.includes("draft-holmer-rmcat-transport-wide-cc-extensions-01")}function Rt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3?arguments[3]:void 0;const{filterRTX:n,filterVideoFec:o,filterAudioFec:r,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=i;let l=[],h=[],u=[],p=[],E=!1,_=!1;if(y(e).mediaDescriptions.forEach((e=>{s&&s!==e.attributes.direction||("video"!==e.media.mediaType||E||(h=e.attributes.payloads,p=e.attributes.extmaps,E=!0),"audio"!==e.media.mediaType||_||(l=e.attributes.payloads,u=e.attributes.extmaps,_=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");if(h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),n&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((e=>{var t;return a.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0){const e=h.filter((e=>{var t;return c.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}));h=e.concat(n?[]:Mt(e,h))}const S=w("UNSUPPORTED_VIDEO_CODEC");return S&&S.length>0&&(h=h.filter((e=>!(e.rtpMap&&S.includes(e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function Tt(e){const t=y(e);let i,s;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,s=e.attributes.icePwd;if(!t||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:s}}if(!s){const t=e.attributes.fingerprints;t.length>0&&(s={fingerprints:t})}}if(!s&&t.attributes.fingerprints.length>0&&(s={fingerprints:t.attributes.fingerprints}),!s||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:s}}function Ct(e,t){const i=[],s=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),n=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(n)n.ssrcIds.forEach((e=>{var n;const o=null===(n=s.find((t=>t.ssrcIds[0]===e)))||void 0===n?void 0:n.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(s.length>0){const e=s[0].ssrcIds[0],n=s[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?n:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function ft(e,t,i){const s=[],n=[];return e.forEach((e=>{let{ssrcId:o,rtx:r}=e;const a=x(8,"track-"),c={ssrcId:o,attributes:Oe({label:a,mslabel:i=i||x(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(s.push(c),void 0!==r){const e={ssrcId:r,attributes:Oe({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};s.push(e),n.push({semantic:"FID",ssrcIds:[o,r]})}})),e.length>1&&n.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:s,ssrcGroups:n}}function At(t,i){i instanceof e&&t.attributes.payloads.forEach((e=>{var t;const s=null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase();if(!s||-1===["opus","pcmu","pcma","g722"].indexOf(s))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const n=i._encoderConfig;n&&"pcmu"!==s&&"pcma"!==s&&"g722"!==s&&(n.bitrate&&!M()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*n.bitrate))),n.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(n.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(n.sampleRate)),n.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function It(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function vt(e,n){if(!(n instanceof t&&n._encoderConfig&&-1===n._hints.indexOf(s.SCREEN_TRACK)))return;const o=n._encoderConfig;i().supportMinBitrate&&o.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(o.bitrateMin))})),i().supportMinBitrate&&!n._hints.includes(s.LOW_STREAM)&&o.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(w("X_GOOGLE_START_BITRATE")||Math.floor(o.bitrateMax)))}))}function gt(e){if("video"!==e.media.mediaType)return;const t=V();if(t.name!==F.SAFARI&&t.os!==B.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function Dt(e,t,i){if(!t)return;let s,n;if("video"===e.media.mediaType?(s=i.videoExtensions,n=i.videoCodecs):(s=i.audioExtensions,n=i.audioCodecs),!0===t.twcc){const t=s.find((e=>mt(e.extensionName)));if(t){const i=t.extensionName;e.attributes.extmaps.find((e=>mt(e.extensionName)))||e.attributes.extmaps.push({entry:t.entry,extensionName:i});const s=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(n,e.attributes.payloads);s.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>mt(e.extensionName)));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=s.find((e=>St(e.extensionName)));if(t){const i=t.extensionName;e.attributes.extmaps.find((e=>e.extensionName===i))||e.attributes.extmaps.push({entry:t.entry,extensionName:i});const s=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(n,e.attributes.payloads);s.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>St(e.extensionName)));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function Nt(e,i,s){if(M())return;if("video"!==e.media.mediaType)return;if(!(i instanceof t))return;if("vp9"!==s&&"vp8"!==s)return;if("vp8"===s&&!w("SIMULCAST"))return;if("vp9"===s&&w("ENABLE_SVC"))return;if(void 0===i._scalabilityMode||i._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===s?2:i._scalabilityMode.numSpatialLayers,o=e.attributes.ssrcs[0],r=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===o.ssrcId)),a={semantic:"SIM",ssrcIds:[o.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:o.ssrcId+t,attributes:k(o.attributes)}),a.ssrcIds.push(o.ssrcId+t),r&&(e.attributes.ssrcs.push({ssrcId:r.ssrcIds[1]+t,attributes:k(o.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[o.ssrcId+t,r.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(a)}async function Lt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const s=(await i.createOffer()).sdp,{send:n,recv:o,sendrecv:r}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const s=Rt(i,e,t,"sendonly"),n=Rt(i,e,t,"recvonly"),o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ot(s,n,"videoExtensions",o,r,a),Ot(s,n,"videoCodecs",o,r,a),Ot(s,n,"audioExtensions",o,r,a),Ot(s,n,"audioCodecs",o,r,a),w("RAISE_H264_BASELINE_PRIORITY")){const e=[],t=[];a.videoCodecs.forEach(((i,s)=>{var n;if("h264"===(null===(n=i.rtpMap)||void 0===n?void 0:n.encodingName.toLocaleLowerCase())){var o,r;const n=a.videoCodecs[s+1],c=n&&Ft(i,n),d=null===(o=i.fmtp)||void 0===o?void 0:o.parameters["profile-level-id"],l=null===(r=i.fmtp)||void 0===r?void 0:r.parameters["packetization-mode"];!d||d!==w("FIRST_H264_PROFILE_LEVEL_ID")||w("FIRST_PACKETIZATION_MODE")&&l!==w("FIRST_PACKETIZATION_MODE")?c?t.push([i,n]):t.push([i]):c?e.push([i,n]):e.push([i])}})),e.length>0&&t.length>0&&(v.debug("raising H264 baseline profile priority"),a.videoCodecs.forEach(((i,s)=>{var n;if("h264"===(null===(n=i.rtpMap)||void 0===n?void 0:n.encodingName.toLocaleLowerCase())){const n=Ft(i,a.videoCodecs[s+1]),o=e.shift()||t.shift()||[];o.length>0&&(n?a.videoCodecs.splice(s,2,...o):a.videoCodecs.splice(s,1,...o))}})),r.videoCodecs=r.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])!==w("FIRST_H264_PROFILE_LEVEL_ID"))})),w("FILTER_SEND_H264_BASELINE")&&(o.videoCodecs=o.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])!==w("FIRST_H264_PROFILE_LEVEL_ID"))}))))}return{send:o,recv:r,sendrecv:a}}(e,t,s);try{i.close()}catch(e){}return{send:n,recv:o,sendrecv:r}}function Pt(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Rt(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ot(e,t,"videoExtensions",i,s,n),Ot(e,t,"videoCodecs",i,s,n),Ot(e,t,"audioExtensions",i,s,n),Ot(e,t,"audioCodecs",i,s,n),w("RAISE_H264_BASELINE_PRIORITY")){const e=n.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=n.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){v.debug("raising H264 baseline profile priority");const i=n.videoCodecs[e];n.videoCodecs.splice(e,1),n.videoCodecs.splice(t,0,i)}-1!==t&&(s.videoCodecs=s.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:i,recv:s,sendrecv:n}}function Ot(e,t,i,s,n,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return r.push(i),!0}))?o[i].push(e):s[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&n[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return r.push(i),!0}))?o[i].push(e):s[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&n[i].push(e)}))}}function wt(e){const{send:t,recv:i,sendrecv:s}=e;if(!s){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let n,o;return t?(n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n.audioCodecs=[...t.audioCodecs,...s.audioCodecs],n.videoCodecs=[...t.videoCodecs,...s.videoCodecs],n.audioExtensions=[...t.audioExtensions,...s.audioExtensions],n.videoExtensions=[...t.videoExtensions,...s.videoExtensions]):n=s,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...s.audioCodecs],o.videoCodecs=[...i.videoCodecs,...s.videoCodecs],o.audioExtensions=[...i.audioExtensions,...s.audioExtensions],o.videoExtensions=[...i.videoExtensions,...s.videoExtensions]):o=s,{send:n,recv:o}}function bt(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function yt(e,t,i,s){let n=[];if(e===Ze.VIDEO){if(w("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(n=t.videoCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===w("H264_PROFILE_LEVEL_ID")))),!Array.isArray(n)||0===n.length){let e=[];const o=[],r=[],a=[];if(i.videoCodecs.forEach((t=>{const i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"";i.includes(s)?e.push(t):i.includes("vp9")?o.push(t):i.includes("vp8")?r.push(t):i.includes("h264")&&a.push(t)})),0===e.length){let t="";0!==o.length?(e=o,t="vp9"):0!==r.length?(e=r,t="vp8"):0!==a.length&&(e=a,t="h264"),v.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(t))}0!==e.length&&(n=t.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(0===n.length&&(v.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),n=t.videoCodecs),w("USE_PUB_RTX")||w("USE_SUB_RTX")){const e=Mt(n,t.videoCodecs);n=[...n,...e]}}else n=t.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s))),0===n.length&&(v.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),n=t.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("opus"))));return n}function Mt(e,t){const i=e.map((e=>e.payloadType.toString()));return t.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&e.fmtp&&e.fmtp.parameters.apt&&i.includes(e.fmtp&&e.fmtp.parameters.apt)))}async function kt(e,t,i){const s=t.toString(),n=xt(s,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:s});const o=await e.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let r=o.sdp;r=Ut(r,i||{}),null==n||n(r||""),await e.setLocalDescription({type:"answer",sdp:r})}function Ut(e,t,i){const s=y(e),{useXR:n}=t;return s.mediaDescriptions.forEach((e=>{e.attributes.mid&&(Array.isArray(i)&&!i.includes(e.attributes.mid)||("audio"===e.media.mediaType&&bt(e),n&&["audio","video"].includes(e.media.mediaType)&&e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))))})),U(s)}function xt(e,t,i,s){if(w("SDP_LOGGING"))return v.upload("exchanging ".concat(i," ").concat(t," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===t?e=>{xt(e,"answer","local"===i?"remote":"local",s)}:void 0}function Vt(e){const t=w("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some((t=>e.includes(t)))}function Ft(e,t){try{var i;return(null===(i=e.fmtp)||void 0===i?void 0:i.parameters.apt)===t.payloadType.toString()}catch(e){return!1}}let Bt=class{get localCapabilities(){return k(this._localCapabilities)}get rtpCapabilities(){return k(this._rtpCapabilities)}get candidates(){return k(this._candidates)}get iceParameters(){return k(this._iceParameters)}get dtlsParameters(){return k(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=k(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:s,remoteRTPCapabilities:n,localCapabilities:o,direction:r,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=r===He.RECEIVE_ONLY?y("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):y("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=n,this._candidates=s,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o;const h=r===He.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,u=r===He.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=r===He.RECEIVE_ONLY?n.send.videoCodecs:yt(Ze.VIDEO,h,u,c),E=r===He.RECEIVE_ONLY?n.send.audioCodecs:yt(Ze.AUDIO,h,u,d);for(const e of l.mediaDescriptions)e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=s,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=p.map((e=>e.payloadType.toString(10))),e.attributes.payloads=p,e.attributes.extmaps=h.videoExtensions),"audio"===e.media.mediaType&&(e.media.fmts=E.map((e=>e.payloadType.toString(10))),e.attributes.payloads=E,e.attributes.extmaps=h.audioExtensions,bt(e));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return U(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,i,s,n){i=i.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:r}=ft(t,this.cname,w("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(M()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,n),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,s);let i;return-1===t?(i=this.createOrRecycleSendMedia(e,o,r,"sendonly",s,n),this.updateBundleMids()):(i=k(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=o,i.attributes.ssrcGroups=r,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),M()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,i.attributes.mid),{needExchangeSDP:!0,mid:i.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,i){const s=[];return e.forEach((e=>{const n=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(n);let r,a=!1;-1===o?(a=!0,r=this.createOrRecycleRecvMedia(e,[],"recvonly",t,i),this.updateBundleMids()):(r=k(this.sessionDesc.mediaDescriptions[o]),r.attributes.direction="recvonly"),s.push({mid:r.attributes.mid,needCreateTransceiver:a})})),s}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:s,port:n,type:o,relatedAddress:r,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=i?i:"",priority:c?c+"":"",connectionAddress:null!=s?s:"",port:n?n+"":"",type:o?o+"":"",relAddr:null!=r?r:"",relPort:a?a+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,s,n){const o=e._mediaStreamTrack.kind,r=this.rtpCapabilities.recv,a=yt(o,r,this.localCapabilities.send,o===Ze.AUDIO?n:s),c=o===Ze.VIDEO?r.videoExtensions:r.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const h=this.findFirstClosedMedia(o);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex((s=>{const n=s.media.mediaType===e&&"0"!==s.media.port&&("sendonly"===s.attributes.direction||"sendrecv"===s.attributes.direction)&&0===s.attributes.ssrcs.length;if(M()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==s.attributes.mid&&"1"!==s.attributes.mid)||!(!e||e!==s.attributes.mid)}return!1}return n&&s.attributes.mid===i}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const i=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&i}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=k(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,i,s,n,o){const r=this.rtpCapabilities.send,a=e===Ze.VIDEO?r.videoCodecs:r.audioCodecs,c=e===Ze.VIDEO?r.videoExtensions:r.audioExtensions;M()&&(n="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:s,rtcpMux:!0,rtcpRsize:!0,mid:n}};d=this.mungSendMediaDesc(d,o);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,i){const s=k(e);return It(s),At(s,t),vt(s,t),gt(s),Dt(s,i,this.localCapabilities.send),s}mungSendMediaDesc(e,t){const i=k(e);return Dt(i,t,this.localCapabilities.recv),bt(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>M()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const Gt=["sdp"];var Wt;let Ht=(Wt=class e extends ze{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,s){super(t,i),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this._isInRestartIce=!1,this.mutex=void 0,this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=i,this.spec=t,this.mutex=new G("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=s?s:He.SEND_ONLY,this.name=this.direction===He.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=W(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,M()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const t=await Lt();if(this.localCapabilities=wt(t),e){const{sdp:t}=e,i=function(e,t){if(null==e)return{};var i,s,n=function(e,t){if(null==e)return{};var i={};for(var s in e)if({}.hasOwnProperty.call(e,s)){if(-1!==t.indexOf(s))continue;i[s]=e[s]}return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(s=0;s<o.length;s++)i=o[s],-1===t.indexOf(i)&&{}.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}(e,Gt),s=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Rt(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ot(t,e,"videoExtensions",i,s,n),Ot(t,e,"videoCodecs",i,s,n),Ot(t,e,"audioExtensions",i,s,n),Ot(t,e,"audioCodecs",i,s,n),w("RAISE_H264_BASELINE_PRIORITY")){const e=n.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=n.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){v.debug("raising H264 baseline profile priority");const i=n.videoCodecs[e];n.videoCodecs.splice(e,1),n.videoCodecs.splice(t,0,i)}-1!==t&&w("FILTER_SEND_H264_BASELINE")&&(i.videoCodecs=i.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:i,recv:s,sendrecv:n}}({},{},t);this.remoteSDP=new Bt({remoteIceParameters:i.iceParameters,remoteDtlsParameters:i.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const o=Tt(n.sdp);await this.peerConnection.setLocalDescription(n);const r=await Pt({},{},n.sdp);this.localCapabilities=wt(r);const a=this.peerConnection.getTransceivers()[0];return null!=a&&a.receiver&&a.receiver.transport&&this.tryBindTransportEvents(a.receiver.transport),Oe(Oe({},o),{},{sdp:n.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Tt(e.sdp);return this.initialOffer=e,Oe(Oe({},t),{},{sdp:e.sdp})}}catch(e){throw new H(K.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:i,dtlsParameters:s}=e,n=await Pt({},{},t);this.remoteSDP=new Bt({remoteIceParameters:i,remoteDtlsParameters:s,candidates:[],remoteRTPCapabilities:n,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new H(K.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,i){var s=this;return we((function*(){const n=yield Ne(s.mutex.lock("From P2PConnection.send"));try{if(!s.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],r=s.remoteSDP.receive(e,t,i);e.forEach(((e,t)=>{if(r[t].needCreateTransceiver){const t=s.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)}else{const i=s.peerConnection.getTransceivers().find((e=>e.mid===r[t].mid));if(!i)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(r[t].mid));o.push(i),e._updateRtpTransceiver(i)}})),M()&&!0===w("SIMULCAST")&&(yield Ne(s.applySimulcastForFirefox(o,e)));const a=r.map((e=>e.mid)),c=yield Ne(s.peerConnection.createOffer()),d=s.mungSendOfferSDP(c.sdp,e,a),l=y(d),h=a.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Ct(t,w("USE_PUB_RTX"))})),u=o.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}));yield Ne(s.peerConnection.setLocalDescription({type:"offer",sdp:d}));try{yield u}catch(e){const t=s.remoteSDP.toString();throw yield Ne(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Ne(s.peerConnection.setRemoteDescription({type:"answer",sdp:t})),yield Ne(s.stopSending(a,!0)),e}yield Ne(s.applySimulcastEncodings(o,e)),yield Ne(s.applySendEncodings(o,e));const p=s.remoteSDP.toString(),E=s.logSDPExchange(d,"offer","local","send");return null==E||E(p),yield Ne(s.setRemoteDescription({type:"answer",sdp:p})),o.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}))}catch(e){throw e instanceof H?e:new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const s=await this.peerConnection.createOffer(),n=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==n||n(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:n,needExchangeSDP:o}=this.remoteSDP.send(e,t,i,s);if(o){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(s.sdp,n,e);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((e=>e.mid===n));if(!r||null===r.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,mid:r.mid,transceiver:r}}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,t,i,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:n,needExchangeSDP:o}=this.remoteSDP.send(e,t,i,s);if(o){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(s.sdp,n,e);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer();null==i||i(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Y.Auto&&(this.store.p2pTransport=Y.SdRtn,i().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,i().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=Tt(e.sdp);return this.store.descriptionStart(),this.direction===He.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===He.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=Tt(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const n=this.remoteSDP.toString(),o=this.logSDPExchange(s,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),null==o||o(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?M()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:s}=t.getSelectedCandidatePair();return{local:Oe(Oe({},q),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Oe(Oe({},q),{},{candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;["connected","completed"].includes(this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var t;if(e.candidate.candidate)null===(t=this.onLocalCandidate)||void 0===t||t.call(this,e.candidate.toJSON());this.localCandidateCount+=1}else v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,s){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const o={iceServers:[]};return t.iceServers?o.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(j(t.turnServer.servers)?o.iceServers=t.turnServer.servers:(o.iceServers&&o.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers,s,n)),w("USE_TURN_SERVER_OF_GATEWAY")&&o.iceServers&&t.turnServer.serversFromGateway&&o.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway,s,n)),[Y.Relay,Y.SdRtn].includes(s)&&(o.iceTransportPolicy="relay"),w("FORCE_TURN_TCP")?o.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(o.iceTransportPolicy="relay")})))),w("ENABLE_ENCODED_TRANSFORM")&&i().supportWebRTCEncodedTransform&&(o.encodedInsertableStreams=!0),v.debug("P2PConnection p2pTransport is ".concat(s)),o}static turnServerConfigToIceServers(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s=[],n=e.filter((e=>e.tcpport));v.debug("P2PConnection turnServers is ".concat(n,", current index is ").concat(i));const o=n.length>i?n[i]:n[0];switch(t){case Y.SdRtn:const t=e.filter((e=>e.username.includes("glb:")&&e.turnServerURL==e.turnServerURL)),n=t.length>i?t[i]:t[0];n&&(s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(ct(n.turnServerURL),":").concat(n.tcpport,"?transport=udp")}),s.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(ct(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}));break;case Y.Relay:o&&(s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ct(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ct(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return s}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const t=e.iceTransport;t&&(t.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},t.getSelectedCandidatePair&&(t.onselectedcandidatepairchange=()=>{if(t.getSelectedCandidatePair()){const{local:e,remote:i}=t.getSelectedCandidatePair();v.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n;if(!t){t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!t)return v.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return v.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!i().supportSetRtpSenderParameters)return v.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},r={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(r.maxBitrate=1e3*t),e._hints.includes(s.LOW_STREAM)&&(i&&(r.maxFramerate=dt(i)),n&&n>=1&&(r.scaleResolutionDownBy=n))}if(w("DSCP_TYPE")&&J()){const e=w("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(r.networkPriority=e)}const a=t.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];M()&&!c&&(o.encodings=[r]),c&&Object.assign(c,r),Object.assign(a,o),v.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await t.setParameters(a)}async applySendEncodings(e,s){try{if(!i().supportSetRtpSenderParameters)return;if(e.length!==s.length)return;for(let i=0;i<e.length;i++){const n=e[i],o=s[i];o instanceof t&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,n.sender)}}catch(e){v.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const s=y(e);return t.forEach(((e,t)=>{const n=i[t],o=s.mediaDescriptions.find((e=>e.attributes.mid===n));o&&(At(o,e),Nt(o,e,this.store.codec))})),U(s)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var s;null===(s=this.onFirstVideoDecoded)||void 0===s||s.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,o,r,a;const d=e[c],l=i[c];if(l instanceof t&&!l._hints.includes(s.LOW_STREAM)&&null!==(n=l._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(o=l._encoderConfig)||void 0===o?void 0:o.bitrateMax)>200&&null!==(r=l._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(a=l._scalabilityMode)||void 0===a?void 0:a.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=d.sender.getParameters();await d.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,i){if(!M()&&e.length===i.length)for(let s=0;s<e.length;s++){const n=i[s];if(n instanceof t&&this.isVP8Simulcast(n)){const t=e[s],i={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};i.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,i))}}}isVP8Simulcast(e){var i,n,o,r;return!!(e instanceof t&&w("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(s.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(o=e._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=e._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1)}logSDPExchange(e,t,i,s){if(w("SDP_LOGGING"))return v.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",s)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),s=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const n=this.remoteSDP.toString();null==s||s(n),await this.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),s=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const n=this.remoteSDP.toString();null==s||s(n),await this.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var i,s;if(t=null!==(i=t)&&void 0!==i?i:null===(s=this.currentRemoteDescription)||void 0===s?void 0:s.sdp){var n;const i=null===(n=y(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===n?void 0:n.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}async setRemoteDescription(e){await this.peerConnection.setRemoteDescription(e),["connected","completed"].includes(this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){const s=y(e),n=s.mediaDescriptions.find((e=>e.attributes.mid===t));return n&&i===Ze.AUDIO&&"audio"===n.media.mediaType&&bt(n),U(s)}},De(Wt.prototype,"establish",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"establish"),Wt.prototype),De(Wt.prototype,"connect",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"connect"),Wt.prototype),De(Wt.prototype,"receive",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"receive"),Wt.prototype),De(Wt.prototype,"mockReceive",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"mockReceive"),Wt.prototype),De(Wt.prototype,"stopReceiving",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"stopReceiving"),Wt.prototype),De(Wt.prototype,"restartICE",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"restartICE"),Wt.prototype),De(Wt.prototype,"close",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"close"),Wt.prototype),De(Wt.prototype,"updateEncoderConfig",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"updateEncoderConfig"),Wt.prototype),De(Wt.prototype,"updateSendParameters",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"updateSendParameters"),Wt.prototype),De(Wt.prototype,"replaceTrack",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"replaceTrack"),Wt.prototype),De(Wt.prototype,"muteLocal",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"muteLocal"),Wt.prototype),De(Wt.prototype,"unmuteLocal",[Kt],Object.getOwnPropertyDescriptor(Wt.prototype,"unmuteLocal"),Wt.prototype),Wt);function Kt(e,t,i){const s=e[t];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return await s.apply(this,o)}finally{i()}},i}const Yt=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};var qt=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(qt||{}),jt=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e[e.BYTES_RETRANSMIT=2173]="BYTES_RETRANSMIT",e[e.PACKAGES_RETRANSMIT=2172]="PACKAGES_RETRANSMIT",e[e.HUGE_FRAME_SENT=2174]="HUGE_FRAME_SENT",e[e.KEY_FRAMES_ENCODED=2207]="KEY_FRAMES_ENCODED",e}(jt||{}),Jt=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(Jt||{}),Xt=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e[e.FRAMES_DROPPED=2181]="FRAMES_DROPPED",e[e.BYTES_RETRANSMIT=2175]="BYTES_RETRANSMIT",e[e.PACKAGES_RETRANSMIT=2176]="PACKAGES_RETRANSMIT",e[e.PACKAGES_DISCARDED=2198]="PACKAGES_DISCARDED",e[e.AVG_DECODE=2200]="AVG_DECODE",e[e.AVG_PROCESSING_DELAY=2202]="AVG_PROCESSING_DELAY",e[e.AVG_ASSEMBLY_TIME=2203]="AVG_ASSEMBLY_TIME",e[e.AVG_INTER_FRAME_DELAY=2204]="AVG_INTER_FRAME_DELAY",e[e.KEY_FRAMES_DECODED=2206]="KEY_FRAMES_DECODED",e}(Xt||{}),zt=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(zt||{}),Qt=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(Qt||{}),Zt=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e[e.BYTES_RETRANSMIT=2179]="BYTES_RETRANSMIT",e[e.PACKAGES_RETRANSMIT=2180]="PACKAGES_RETRANSMIT",e}(Zt||{}),$t=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e[e.BYTES_RETRANSMIT=2178]="BYTES_RETRANSMIT",e[e.PACKAGES_RETRANSMIT=2177]="PACKAGES_RETRANSMIT",e[e.PACKAGES_DISCARDED=2199]="PACKAGES_DISCARDED",e[e.AVG_PROCESSING_DELAY=2201]="AVG_PROCESSING_DELAY",e[e.TOTAL_SAMPLES_RECEIVED=2224]="TOTAL_SAMPLES_RECEIVED",e}($t||{}),ei=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(ei||{}),ti=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e}(ti||{}),ii=function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e}(ii||{});class si extends O{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(w("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const s=this.resultStorage.get(e);if(s&&(s.result.push(i),s.result.length>=5)){const i=s.result.includes(!0);s.isPrevNormal&&!i&&this.emit("exception",ni[e],e,t),!s.isPrevNormal&&i&&this.emit("exception",ni[e]+2e3,e+"_RECOVER",t),s.isPrevNormal=i,s.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof o&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=dt(t._encoderConfig.frameRate));const s=e.captureFrameRate;return!i||!s||!(i>10&&s<5||i<10&&i>=5&&s<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof o&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const ni={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};class oi{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=b.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.exceptionMonitor=new si,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(et.LocalAudioTrack)||Oe({},r)}getLocalVideoTrackStats(){return this.localStats.get(et.LocalVideoTrack)||Oe({},a)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var s;const n=null===(s=this.remoteStats.get(e))||void 0===s?void 0:s.audioStats;n&&(i[e]=t(e,n))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[s,{audioStats:n}]=e;n&&(i[s]=t(s,n))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const s=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;s&&(t[e]=s)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:s}]=e;s&&(t[i]=s)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var s;const n=null===(s=this.remoteStats.get(e))||void 0===s?void 0:s.videoStats;n&&(i[e]=t(e,n))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[s,{videoStats:n}]=e;n&&(i[s]=t(s,n))}));return i}getRTCStats(){let e=0,t=0,i=0,s=0;const n=this.localStats.get(et.LocalAudioTrack);n&&(e+=n.sendBytes,t+=n.sendBitrate);const o=this.localStats.get(et.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const r=this.localStats.get(et.LocalVideoLowTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:n}=e;t&&(i+=t.receiveBytes,s+=t.receiveBitrate),n&&(i+=n.receiveBytes,s+=n.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:s,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),s=null!=i&&i.videoSSRC?Yt.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,n=null!=i&&i.audioSSRC?Yt.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,s>n?s:n),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&v.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const s=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,n=!i||t.framesDecodeCount>i.framesDecodeCount;return s||!n}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((t=>{let[i,s]=t;switch(i){case et.LocalVideoTrack:case et.LocalVideoLowTrack:{const t=s,o=Oe({},a),r=e.getStats(),c=e.getLocalMedia(i);if(r){const i=r.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(i){const s=e.getLocalVideoSize(),n=e.getEncoderConfig(et.LocalVideoTrack);"H264"!==i.codec&&"H265"!==i.codec&&"VP8"!==i.codec&&"VP9"!==i.codec&&"AV1X"!==i.codec&&"AV1"!==i.codec||(o.codecType=i.codec),o.sendBytes=i.bytes,o.sendBitrate=t?8*Math.max(0,o.sendBytes-t.sendBytes):0,i.inputFrame?(o.captureFrameRate=i.inputFrame.frameRate,o.captureResolutionHeight=i.inputFrame.height,o.captureResolutionWidth=i.inputFrame.width):s&&(o.captureResolutionWidth=s.width,o.captureResolutionHeight=s.height),i.sentFrame?(o.sendFrameRate=i.sentFrame.frameRate,o.sendResolutionHeight=i.sentFrame.height,o.sendResolutionWidth=i.sentFrame.width):s&&(o.sendResolutionWidth=s.width,o.sendResolutionHeight=s.height),i.avgEncodeMs&&(o.encodeDelay=i.avgEncodeMs),n&&n.bitrateMax&&(o.targetSendBitrate=1e3*n.bitrateMax),o.sendPackets=i.packets,o.sendPacketsLost=i.packetsLost,o.sendJitterMs=i.jitterMs,o.sendRttMs=i.rttMs,o.totalDuration=t?t.totalDuration+1:1,o.totalFreezeTime=t?t.totalFreezeTime:0,this.isLocalVideoFreeze(i)&&(o.totalFreezeTime+=1),i.scalabilityMode&&this.scalabilityMode!==i.scalabilityMode&&(v.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(i.scalabilityMode)),this.scalabilityMode=i.scalabilityMode)}this.trafficStats&&(o.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var n;if(this.localStats.set(i,o),(null==t?void 0:t.sendResolutionWidth)!==o.sendResolutionWidth||(null==t?void 0:t.sendResolutionHeight)!==o.sendResolutionHeight)null===(n=this.onStatsChanged)||void 0===n||n.call(this,"resolution",{width:o.sendResolutionWidth,height:o.sendResolutionHeight});o&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,o);break}case et.LocalAudioTrack:{const t=s,n=Oe({},r),o=e.getStats(),a=e.getLocalMedia(i);if(o){const i=o.audioSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(i){if("opus"!==i.codec&&"aac"!==i.codec&&"PCMU"!==i.codec&&"PCMA"!==i.codec&&"G722"!==i.codec||(n.codecType=i.codec),i.inputLevel)n.sendVolumeLevel=Math.round(32767*i.inputLevel);else{const t=e.getLocalAudioVolume();t&&(n.sendVolumeLevel=Math.round(32767*t))}n.sendBytes=i.bytes,n.sendPackets=i.packets,n.sendPacketsLost=i.packetsLost,n.sendJitterMs=i.jitterMs,n.sendRttMs=i.rttMs,n.sendBitrate=t?8*Math.max(0,n.sendBytes-t.sendBytes):0}}this.trafficStats&&(n.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(et.LocalAudioTrack,n),n&&a&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,a.track,n);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var i,s;let[n,{videoStats:o,audioStats:r,videoPcStats:a}]=t;const h=r,u=o,p=a,E=Oe({},c),_=Oe({},d),S=Oe({},l),{audioTrack:m,videoTrack:R,audioSSRC:T,videoSSRC:C}=e.getRemoteMedia(n);let f;f=this.store.useP2P?e.getStats(!0):e.getStats();const A=null===(i=f)||void 0===i?void 0:i.audioRecv.find((e=>e.ssrc===T)),I=null===(s=f)||void 0===s?void 0:s.videoRecv.find((e=>e.ssrc===C)),v=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===n));if(A&&("opus"!==A.codec&&"aac"!==A.codec&&"PCMU"!==A.codec&&"PCMA"!==A.codec&&"G722"!==A.codec||(E.codecType=A.codec),A.outputLevel?E.receiveLevel=Math.round(32767*A.outputLevel):m&&(E.receiveLevel=Math.round(32767*m.getVolumeLevel())),E.receiveBytes=A.bytes,E.receivePackets=A.packets,E.receivePacketsLost=A.packetsLost,E.receivePacketsDiscarded=A.packetsDiscarded,E.packetLossRate=E.receivePacketsLost/(E.receivePackets+E.receivePacketsLost),E.receiveBitrate=h?8*Math.max(0,E.receiveBytes-h.receiveBytes):0,E.totalDuration=h?h.totalDuration+1:1,E.totalFreezeTime=h?h.totalFreezeTime:0,E.freezeRate=E.totalFreezeTime/E.totalDuration,E.receiveDelay=A.jitterBufferMs,E.totalDuration>10&&oi.isRemoteAudioFreeze(m)&&(E.totalFreezeTime+=1)),I){var g;"H264"!==I.codec&&"H265"!==I.codec&&"VP8"!==I.codec&&"VP9"!==I.codec&&"AV1X"!==I.codec&&"AV1"!==I.codec||(_.codecType=I.codec),_.receiveBytes=I.bytes,_.receiveBitrate=u?8*Math.max(0,_.receiveBytes-u.receiveBytes):0,_.decodeFrameRate=I.decodeFrameRate<0?0:I.decodeFrameRate,_.renderFrameRate=I.decodeFrameRate<0?0:I.decodeFrameRate,I.outputFrame&&(_.renderFrameRate=I.outputFrame.frameRate),I.receivedFrame?(_.receiveFrameRate=I.receivedFrame.frameRate,_.receiveResolutionHeight=I.receivedFrame.height,_.receiveResolutionWidth=I.receivedFrame.width):R&&(_.receiveResolutionHeight=R._videoHeight||0,_.receiveResolutionWidth=R._videoWidth||0),void 0!==I.framesRateFirefox&&(_.receiveFrameRate=Math.round(I.framesRateFirefox)),_.receivePackets=I.packets,_.receivePacketsLost=I.packetsLost,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost);const t=u?u.totalFreezeTime:0,i=u?u.totalDuration:0;_.totalDuration=u?u.totalDuration+1:1,_.totalFreezeTime=null!==(g=I.totalFreezesDuration)&&void 0!==g?g:t||0,_.receiveDelay=I.jitterBufferMs||0;const s=!!C&&e.getRemoteVideoIsReady(C);void 0===I.totalFreezesDuration&&R&&s&&oi.isRemoteVideoFreeze(R,I,p)&&(_.totalFreezeTime+=1),_.freezeRate=Math.max(0,Math.min((_.totalFreezeTime-t)/(_.totalDuration-i),1))}v&&(E.end2EndDelay=v.B_ad,_.end2EndDelay=v.B_vd,E.transportDelay=v.B_ed,_.transportDelay=v.B_ed,E.currentPacketLossRate=v.B_ealr4/100,_.currentPacketLossRate=v.B_evlr4/100,S.uplinkNetworkQuality=v.B_punq?v.B_punq:0,S.downlinkNetworkQuality=v.B_pdnq?v.B_pdnq:0),this.remoteStats.set(n,{audioStats:E,videoStats:_,videoPcStats:I,networkStats:S}),m&&this.exceptionMonitor.setRemoteAudioStats(m,E),R&&this.exceptionMonitor.setRemoteVideoStats(R,_)}))}}const ri=1e3,ai=6,ci=3,di=Math.max(ai,ci);function li(e,t,i){null!=i&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function hi(e){const t={[ti.CONN_TYPE]:0,[ti.RTT]:e.rtt,[ti.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t[ti.CONN_TYPE]=1),"tcp"===i&&(t[ti.CONN_TYPE]=3),"tls"===i&&(t[ti.CONN_TYPE]=4);break}case"srflx":t[ti.CONN_TYPE]=2;break;case"unknown":t[ti.CONN_TYPE]=5;break;default:t[ti.CONN_TYPE]=0}return t}function ui(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class pi extends O{constructor(e){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadBaseStatsStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastRefRecvStats=void 0,this.lastRefSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;const t=e%ci==0,i=e%ai==0;let s,n;if(this.uploadTransportStarted&&(s=this.requestStats(),this.store.useP2P&&(n=this.requestStats(!0))),!s&&this.uploadOutboundStarted&&(s=this.requestStats()),!n&&this.uploadInboundStarted&&(n=this.requestStats(!0)),s||n){var o;const e={};if(this.uploadTransportStarted&&s){const i=this.getTransportStats(s,n,t);i&&(e.misc=[i])}if(this.uploadOutboundStarted&&s){const n=this.getOutboundStats(s,i?this.lastFullSendStats:t?this.lastRefSendStats:this.lastSendStats,t,i);n&&(e.outbound=[n])}if(this.uploadInboundStarted&&n){const s=this.getInboundStats(n,i?this.lastFullRecvStats:t?this.lastRefRecvStats:this.lastRecvStats,t,i);s&&(e.inbound=s)}const r=null===(o=this.requestTransportStats)||void 0===o?void 0:o.call(this).connectState;r&&(Array.isArray(e.misc)?e.misc[0]&&e.misc[0].addition&&(e.misc[0].addition[ii.RTC_PEER_CONNECTION_STATE]=X[r]):e.misc=[{addition:{[ii.RTC_PEER_CONNECTION_STATE]:X[r]}}]),this.requestUploadStats(e)}this.lastRecvStats=n,this.lastSendStats=s,i&&(this.lastFullRecvStats=n,this.lastFullSendStats=s),t&&(this.lastRefRecvStats=n,this.lastRefSendStats=s)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var t,i;const e=null===(t=this.requestTransportStats)||void 0===t?void 0:t.call(this);return void(e&&(null===(i=this.requestUploadStats)||void 0===i||i.call(this,{misc:[{addition:{[ii.RTC_PEER_CONNECTION_STATE]:X[e.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===di+1&&(e=1)}),ri)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,i){if(!this.requestStats)return;if(!i)return null==e.rtt?void 0:{addition:{[ti.RTT]:e.rtt,[ti.CONN_TYPE]:void 0,[ti.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};const s=hi(e);if(this.store.useP2P){if(t){const e=hi(t);s[ti.CONN_TYPE]+=e[ti.CONN_TYPE]<<3}s[ti.CONN_TYPE]+=110}else s[ti.CONN_TYPE]+=100;return{addition:s}}getOutboundStats(e,t,i,s){if(!this.requestUploadStats||!this.requestLocalMedia)return;const n=this.requestLocalMedia();if(!n||0===n.length)return;let o,r,a;return n.forEach((n=>{let[c,{track:d,ssrcs:l}]=n;switch(c){case et.LocalVideoLowTrack:case et.LocalVideoTrack:if(c===et.LocalVideoTrack){const n=function(e,t,i,s,n,o){const r=t.videoSend.find((t=>t.ssrc===e));if(!r)return;const a={},{sentFrame:c,inputFrame:d}=r;if(o&&(li(a,jt.QP_SUM,r.qpSumPerFrame),d&&c)){const e=d.frameRate,t=c.frameRate;a[jt.FREEZE]=function(e,t){let i=!0;return i=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),i}(e,t)?1:0}if(n){switch(c&&(li(a,jt.HEIGHT,c.height),li(a,jt.WIDTH,c.width),li(a,jt.FRAME_RATE,c.frameRate)),a[jt.DISABLED]=s._originMediaStreamTrack&&!s._originMediaStreamTrack.enabled||s._mediaStreamTrack&&!s._mediaStreamTrack.enabled?1:0,r.adaptionChangeReason){case"none":a[jt.ADAPTATION]=0;break;case"cpu":a[jt.ADAPTATION]=1;break;case"bandwidth":a[jt.ADAPTATION]=2;break;case"other":a[jt.ADAPTATION]=3}let o=0;r.adaptionChangeReason&&(o+=ui(r.adaptionChangeReason)),t.qualityLimitationReason&&(o+=ui(t.qualityLimitationReason)<<3),a[jt.ADAPTATION]=o,a[jt.PLAYER_STATUS]=h[s._player?s._player.videoElementStatus:"uninit"],li(a,jt.NACKS,r.nacksCount),li(a,jt.PLIS,r.plisCount),li(a,jt.FIRS,r.firsCount),li(a,jt.AVG_ENCODE,r.avgEncodeMs),li(a,jt.HUGE_FRAME_SENT,r.hugeFramesSent),li(a,jt.BYTES_RETRANSMIT,r.retransmittedBytesSent),li(a,jt.PACKAGES_RETRANSMIT,r.retransmittedPacketsSent),li(a,jt.KEY_FRAMES_ENCODED,r.keyFramesEncoded);const d=i&&i.videoSend.find((t=>t.ssrc===e));if(d){let e=n?ri:ri*ai;d.timestamp&&r.timestamp&&(e=r.timestamp-d.timestamp),null!=d.packets&&null!=r.packets&&li(a,jt.PACKAGE_RATE,1e3*(r.packets-d.packets)/e),null!=r.packetsLost&&null!=d.packetsLost&&li(a,jt.PACKAGE_LOST,r.packetsLost-d.packetsLost),null!=d.bytes&&null!=r.bytes&&li(a,jt.BITRATE,8*(r.bytes-d.bytes)/e)}}return a}(l[0].ssrcId,e,t,d,i,s),o=d&&function(e,t,i,s){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return null;const o={};if(s){const e=n.inputFrame,t=e&&e.height||i.videoHeight||0,s=e&&e.width||i.videoWidth||0,r=e&&e.frameRate||0;li(o,qt.HEIGHT,t),li(o,qt.WIDTH,s),li(o,qt.FRAME_RATE,r)}return o}(l[0].ssrcId,e,d,i),a=function(e,t){const i={};return t&&(li(i,jt.RETRANSMIT,e.bitrate.retransmit),li(i,jt.TARGET_ENCODED,e.bitrate.targetEncoded),li(i,jt.ACTUAL_ENCODED,e.bitrate.actualEncoded),li(i,jt.TRANSMIT,e.bitrate.transmit),li(i,jt.BANDWIDTH,e.sendBandwidth)),i}(e,i);r=Object.assign({},n,o,a)}else a=function(e,t,i,s){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return;const o={};if(s){const t=n.sentFrame;if(t&&(li(o,Jt.HEIGHT,t.height),li(o,Jt.WIDTH,t.width),li(o,Jt.FRAME_RATE,t.frameRate)),i){const t=i.videoSend.find((t=>t.ssrc===e));if(t){let e=ri*ai;t.timestamp&&n.timestamp&&(e=n.timestamp-t.timestamp),null!=t.packets&&null!=n.packets&&li(o,Jt.PACKAGE_RATE,1e3*(n.packets-t.packets)/e),null!=n.packetsLost&&null!=t.packetsLost&&li(o,Jt.PACKAGE_LOST,n.packetsLost-t.packetsLost),null!=t.bytes&&null!=n.bytes&&li(o,Jt.BITRATE,8*(n.bytes-t.bytes)/e)}}}return o}(l[0].ssrcId,e,t,i);break;case et.LocalAudioTrack:o=d&&function(e,t,i,s,n){const o=t.audioSend.find((t=>t.ssrc===e));if(!o)return;const r={};if(n){r[Zt.DISABLED]=s._originMediaStreamTrack&&!s._originMediaStreamTrack.enabled||s._mediaStreamTrack&&!s._mediaStreamTrack.enabled?1:0;const t=100*s._source.getAccurateVolumeLevel(),n=o.inputLevel;if(null!=n){const e=Math.ceil(50*Math.log10(100*n+1));li(r,Zt.LEVEL,e)}li(r,Qt.PCM_LEVEL,t),li(r,Zt.AEC_RETURN_LOSS,o.aecReturnLoss),li(r,Zt.AEC_RETURN_LOSS_ENH,o.aecReturnLossEnhancement),li(r,Zt.BYTES_RETRANSMIT,o.retransmittedBytesSent),li(r,Zt.PACKAGES_RETRANSMIT,o.retransmittedPacketsSent),r[Zt.FREEZE]=0;const a=i&&i.audioSend.find((t=>t.ssrc===e));if(a){let e=ri*ai;a.timestamp&&o.timestamp&&(e=o.timestamp-a.timestamp),null!=a.bytes&&null!=o.bytes&&li(r,Zt.BITRATE,8*(o.bytes-a.bytes)/e),null!=a.packets&&null!=o.packets&&li(r,Zt.PACKAGE_RATE,1e3*(o.packets-a.packets)/e)}}return r}(l[0].ssrcId,e,t,d,i)}})),{high:r,low:a,audio:o}}getInboundStats(e,t,s,n){if(!this.requestRemoteMedia)return;const o=this.requestRemoteMedia()||[],r=[];return o.forEach((o=>{let[a,c]=o;const d={peer:a.uid};if(c.has(Ze.VIDEO)&&a.videoTrack){const o=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,r=a.videoTrack?function(e,t,s,n,o,r,a,c){const d=t.videoRecv.find((t=>t.ssrc===e));if(!d)return;const l={},{receivedFrame:E,outputFrame:_,decodeFrameRate:S}=d,m=s&&s.videoRecv.find((t=>t.ssrc===e));if(li(l,zt.FRAME_RATE_DECODE,S),d.framesRateFirefox&&li(l,Xt.FRAME_RATE,d.framesRateFirefox),E&&li(l,Xt.FRAME_RATE,E.frameRate),li(l,Xt.FRAMES_DROPPED,d.framesDroppedCount),li(l,Xt.BYTES_RETRANSMIT,d.retransmittedBytesReceived),li(l,Xt.PACKAGES_RETRANSMIT,d.retransmittedPacketsReceived),li(l,Xt.PACKAGES_DISCARDED,d.packetsDiscarded),li(l,Xt.AVG_DECODE,d.avgDecodeMs),li(l,Xt.AVG_PROCESSING_DELAY,d.avgProcessingDelayMs),li(l,Xt.AVG_ASSEMBLY_TIME,d.avgFramesAssembledFromMultiplePacketsMs),li(l,Xt.AVG_INTER_FRAME_DELAY,d.avgInterFrameDelayMs),li(l,Xt.KEY_FRAMES_DECODED,d.keyFramesDecoded),m){const e=t.timestamp-s.timestamp||ri*(c?ai:a?ci:1);null!=d.packetsLost&&null!=m.packetsLost&&li(l,Xt.PACKAGE_LOST,d.packetsLost-m.packetsLost),null!=m.bytes&&null!=d.bytes&&li(l,Xt.BITRATE,8*(d.bytes-m.bytes)/e),null!=m.packets&&null!=d.packets&&li(l,Xt.PACKAGE_RATE,1e3*(d.packets-m.packets)/e)}if(c&&(li(l,Xt.QP_SUM,d.qpSumPerFrame),l[Xt.FREEZE]=o&&oi.isRemoteVideoFreeze(n,d,m)?1:0),a){var R;E?(li(l,Xt.HEIGHT,E.height),li(l,Xt.WIDTH,E.width)):n&&(li(l,Xt.HEIGHT,n._videoHeight||0),li(l,Xt.WIDTH,n._videoWidth||0)),_&&li(l,zt.FRAME_RATE_OUTPUT,_.frameRate);const e=null===(R=n._player)||void 0===R?void 0:R.rendFrameRate.toFixed(0);if(e&&li(l,zt.FRAME_RATE_RENDER,+e),li(l,Xt.JITTER_BUFFER,d.jitterBufferMs),li(l,Xt.CURRENT_DELAY,d.currentDelayMs),li(l,Xt.FIRS,d.firsCount),li(l,Xt.NACKS,d.nacksCount),li(l,Xt.PLIS,d.plisCount),n){l[Xt.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1;const e=n._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:s,videoElementStatus:n}=e;if(t&&t.length>0&&li(l,zt.FREEZE_TIME,t.splice(0,1)[0]),r&&"visible"===u.visibility&&n===p.PLAYING&&i().supportRequestVideoFrameCallback){const t=Math.min(6e3,s);e.renderFreezeAccTime=Math.max(0,s-t),li(l,zt.FREEZE_TIME_RENDER,t)}if("number"==typeof d.totalFreezesDuration){const e=m&&m.totalFreezesDuration?d.totalFreezesDuration-m.totalFreezesDuration:d.totalFreezesDuration;li(l,zt.FREEZE_DURATION,1e3*e)}}}if(l[Xt.PLAYER_STATUS]=h[n._player?n._player.videoElementStatus:"uninit"],m&&void 0!==d.totalInterFrameDelay&&void 0!==d.totalSquaredInterFrameDelay&&void 0!==m.totalInterFrameDelay&&void 0!==m.totalSquaredInterFrameDelay){const e=d.totalInterFrameDelay-m.totalInterFrameDelay,t=d.totalSquaredInterFrameDelay-m.totalSquaredInterFrameDelay,i=d.framesDecodeCount-m.framesDecodeCount,s=e/i*1e3,n=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/i)/i));!isNaN(n)&&s+n>Math.max(3*s,s+150)&&(l[Xt.I_FRAME_DELAY]=n)}}return l}(a._videoSSRC,e,t,a.videoTrack,!0===o,this.needUploadRenderFreezeTime,s,n):void 0;r&&(d.video=r)}if(c.has(Ze.AUDIO)&&a.audioTrack){const i=a.audioTrack?function(e,t,i,s,n,o){const r=t.audioRecv.find((t=>t.ssrc===e));if(!r)return;const a={},c=i&&i.audioRecv.find((t=>t.ssrc===e));if(li(a,$t.JITTER,r.jitterMs),li(a,$t.BYTES_RETRANSMIT,r.retransmittedBytesReceived),li(a,$t.PACKAGES_RETRANSMIT,r.retransmittedPacketsReceived),li(a,$t.PACKAGES_DISCARDED,r.packetsDiscarded),li(a,$t.AVG_PROCESSING_DELAY,r.avgProcessingDelayMs),c){const e=t.timestamp-i.timestamp||ri*(o?ai:n?ci:1);null!=r.packets&&null!=c.packets&&li(a,$t.PACKAGE_RATE,1e3*(r.packets-c.packets)/e),n&&null!=c.bytes&&null!=r.bytes&&li(a,$t.BITRATE,8*(r.bytes-c.bytes)/e),null!=r.packetsLost&&null!=c.packetsLost&&li(a,$t.PACKAGE_LOST,r.packetsLost-c.packetsLost)}if(o){const{receivedFrames:e,droppedFrames:t}=r;null!=e&&null!=t&&(a[$t.FREEZE]=0===(d=e)||100*t/d>20?1:0)}var d;if(n){const e=100*s._source.getAccurateVolumeLevel(),t=r.outputLevel;if(null!=t){const e=Math.ceil(50*Math.log10(100*t+1));li(a,ei.LEVEL,e)}if(li(a,$t.PCM_LEVEL,e),s&&(a[$t.DISABLED]=s._originMediaStreamTrack.enabled&&s._mediaStreamTrack.enabled?0:1),li(a,$t.JITTER_BUFFER,r.jitterBufferMs),li(a,$t.CURRENT_DELAY,r.jitterBufferMs),a[$t.PLAYER_STATUS]=h[E.getPlayerState(s.getTrackId())],c){const e=r.concealedSamples-c.concealedSamples;e>0&&li(a,$t.CONCEALED_SAMPLES,e);const t=r.totalSamplesReceived-c.totalSamplesReceived;t>0&&li(a,$t.TOTAL_SAMPLES_RECEIVED,t)}}return a}(a._audioSSRC,e,t,a.audioTrack,s,n):void 0;i&&(d.audio=i)}(d.video||d.audio)&&r.push(d)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,r}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof _));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(Ge.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{if(!this.requestUpload||!this.requestRemoteMedia)return;(this.requestRemoteMedia()||[]).forEach((e=>{let[t,i]=e;if(i.has(Ze.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}if(i.has(Ze.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),i={connectionInterval:w("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let s=[];const n=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of n)!e.muted&&e.enabled&&(s=s.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,t]of o)t.has(Ze.VIDEO)&&e.videoTrack&&(s=s.concat(await e.videoTrack.getProcessorUsage())),t.has(Ze.AUDIO)&&e.audioTrack&&(s=s.concat(await e.audioTrack.getProcessorUsage()));if(0===s.length)return;i.details=function(e,t){const i={};for(const{id:r,value:a,level:c,direction:d}of e){var s;const e=null!==(s=t.get(r))&&void 0!==s?s:0,l=2===a?e+w("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var n,o;t.set(r,l),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===d&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(n=t.get(r))&&void 0!==n?n:0):i[r]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:s,totalTs:n}=i[e];return{id:e,level:t,value:s,totalTs:n}}))}(s,e);const r=Date.now(),a=r>t?r:t+1;this.requestUpload&&this.requestUpload(Ge.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:a})}),w("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1}}class Ei{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=e,this._uintid=t}}let _i=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});const Si="9",mi=4e4;class Ri{get localCapabilities(){return k(this._localCapabilities)}get rtpCapabilities(){return k(this._rtpCapabilities)}get candidates(){return k(this._candidates)}get iceParameters(){return k(this._iceParameters)}get dtlsParameters(){return k(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._originCandidates=void 0,this._iceParameters=void 0,this._isUseExtmapAllowMixed=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,this._isUseExtmapAllowMixed=t,e=k(e);const{iceParameters:i,dtlsParameters:s,candidates:n,rtpCapabilities:o,setup:r,localCapabilities:a,cname:c}=e;this._rtpCapabilities=o,this._candidates=n,this._originCandidates=k(n),this._iceParameters=i,this._dtlsParameters=s,this._localCapabilities=a,this.setup=r,this.cname=c,this.sessionDesc=this.updateRemoteRTPCapabilities(o),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(e){const t=this.candidates,i=this.dtlsParameters,s=this.iceParameters,n=this.rtpCapabilities.send;let o=this.sessionDesc.mediaDescriptions.length-1;for(let r=1;r<e;r++){const e=2*r+2e4,a=2*r+mi,{ssrcs:c,ssrcGroups:d}=ft([{ssrcId:e}],this.cname),{ssrcs:l,ssrcGroups:h}=ft([{ssrcId:a,rtx:w("USE_SUB_RTX")?a+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Si,protos:["UDP","TLS","RTP","SAVPF"],fmts:n.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:s.iceUfrag,icePwd:s.icePwd,unrecognized:[],candidates:t,extmaps:n.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:n.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Si,protos:["UDP","TLS","RTP","SAVPF"],fmts:n.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:s.iceUfrag,icePwd:s.icePwd,unrecognized:[],candidates:t,extmaps:n.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:c,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:n.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return U(this.sessionDesc)}send(e,t,i,s){const{ssrcs:n,ssrcGroups:o}=ft(t,this.cname,w("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(n);if(r){if(M()&&this.firefoxSsrcMidMap.set(n[0].ssrcId,r.attributes.mid),s&&(s.twcc||s.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,s),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,n);let i;return-1===t||1===t&&(z()||Q()||w("ENABLE_ENCODED_TRANSFORM")&&Z())||0===t&&w("USE_SUB_RTX")||$()?(i=this.createOrRecycleSendMedia(e,n,o,"sendonly",s),this.updateBundleMids()):(i=k(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=n,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,s)),M()&&this.firefoxSsrcMidMap.set(n[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:s}=e;return this.send(t,i,s)})),i=[];let s=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:n}=e;n&&(s=!0),i.push(t)})),{mids:i,needExchangeSDP:s}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||M()||$()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,s){e.forEach(((e,n)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,s[n])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||y((i=this._isUseExtmapAllowMixed,"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite".concat(i?"\na=extmap-allow-mixed":"","\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n")));var i;this._rtpCapabilities=e;const s=this.rtpCapabilities.send,n=this.localCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType)if(0===s.videoCodecs.length){const t=n.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("vp8")}))||[n.videoCodecs[0]];e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else if(e.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=s.videoCodecs,e.attributes.extmaps=s.videoExtensions,w("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:t,ssrcGroups:i}=ft([{ssrcId:mi,rtx:w("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType)if(0===s.audioCodecs.length){const t=n.audioCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("opus")}))||[n.audioCodecs[0]];e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else if(e.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=s.audioCodecs,e.attributes.extmaps=s.audioExtensions,bt(e),w("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:t,ssrcGroups:i}=ft([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(e){const t=this._originCandidates.filter((e=>"udp"===e.transport)),i=[];if(t.forEach((e=>{i.push(Oe(Oe({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})),0!==t.length){switch(e){case $e.TCP_RELAY:this._candidates=i;break;case $e.UDP_TCP_RELAY:case $e.RELAY:this._candidates=[...t,...i];break;default:this._candidates=t}for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}}restartICE(e){e=k(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const s=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(M()){if(s){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return s}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:Si,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,s,n,o){const r=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=yt(r,a,this.localCapabilities.send,r===Ze.VIDEO?s:n),d=r===Ze.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:r,port:Si,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,o);const u=this.findFirstClosedMedia(r);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,t,i){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(ee).includes(e))))],n=new Set(t);if(s.every((e=>n.has(e))))return v.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===o.length)return v.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(t)),!1;const r=[...new Set(o.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(v.debug("updateRemoteCodec, from ".concat(s," to ").concat(r)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return v.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(w("USE_PUB_RTX")||w("USE_SUB_RTX")){const e=Mt(o,this.rtpCapabilities.recv.videoCodecs);o.push(...e)}this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=yt(Ze.VIDEO,d,c,i);return a.forEach((e=>{const t=l.map((e=>e.payloadType.toString(10)));v.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from"),e.attributes.payloads,"to",l),e.attributes.payloads=l,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,i,s,n){const o=this.rtpCapabilities.send,r=e===Ze.VIDEO?o.videoCodecs:o.audioCodecs,a=e===Ze.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:Si,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:s,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,n);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const s=k(e);return It(s),At(s,t),vt(s,t),gt(s),Dt(s,i,this.localCapabilities.send),s}mungSendMediaDesc(e,t){const i=k(e);return Dt(i,t,this.localCapabilities.recv),bt(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>M()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var Ti=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(Ti||{});const Ci=new Map;function fi(e,t,i,s){let{scale:n}=e;if(0===n&&s===Ti.UP||n>=t.length-1&&s===Ti.DOWN)return e;let o=Oe(Oe({},e),{},{scale:s===Ti.DOWN?++n:--n});switch(i){case"maintain-framerate":o=Oe(Oe({},o),t[n].motion);break;case"maintain-resolution":o=Oe(Oe({},o),t[n].detail);break;case"balanced":o=Oe(Oe({},o),t[n].balanced)}return o}function Ai(e,t){if(t){const i={overUse:0,underUse:0,adaptationList:Ii(t)};Ci.set(e,i)}else Ci.delete(e)}function Ii(e){const t=Oe({},e),{bitrateMax:i,frameRate:s,scaleResolutionDownBy:n,bitrateMin:o}=t,{MIN_FRAME_RATE:r,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:h,BWE_SCALE_DOWN_THRESHOLD:u,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:E,BALANCE_BITRATE_FACTOR:_,BALANCE_FRAMERATE_FACTOR:S,BALANCE_RESOLUTION_FACTOR:m,MOTION_RESOLUTION_FACTOR:R,MOTION_BITRATE_FACTOR:T,DETAIL_FRAMERATE_FACTOR:C,DETAIL_BITRATE_FACTOR:f}=ie,A=Math.min(t.frameRate,a),I=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(u,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(p,1)*A),fps_up:s},balanced:{scaleResolutionDownBy:1,frameRate:s,bitrateMax:i,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:s,bitrateMax:i,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:s,bitrateMax:i,bitrateMin:o}}];for(let e=1;e<=c;e++){const t={bwe_up:Math.round(Math.pow(h,e)*i),bwe_down:Math.round(Math.pow(u,e+1)*i),fps_up:Math.round(Math.pow(E,e)*A),fps_down:Math.round(Math.pow(p,e+1)*A)},a={scaleResolutionDownBy:n/Math.pow(m,e),frameRate:Math.max(Math.round(Math.pow(S,e)*s),r),bitrateMax:Math.max(Math.round(Math.pow(_,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(_,e)*o),d)},c={scaleResolutionDownBy:n/Math.pow(R,e),frameRate:s,bitrateMax:Math.max(Math.round(Math.pow(T,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(T,e)*o),d)},v={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(C,e)*s),r),bitrateMax:Math.max(Math.round(Math.pow(f,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(f,e)*o),d)};I.push({scale:e,threshold:t,balanced:a,motion:c,detail:v})}return I}function vi(e,t,i,s,n,o){const r=Ci.get(e)||{overUse:0,underUse:0,adaptationList:Ii(n)},{adaptationList:a}=r;Ci.set(e,r);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=ie,{scale:l}=s;let h,u;return"number"==typeof t&&t>0&&function(e,t,i,s){if(t>=i.length)return!1;let{threshold:{fps_down:n}}=i[t];return w("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===s&&(n=i[0].threshold.fps_down),e<n}(t,l,a,o)&&(r.overUse++,u=te.CPU,r.overUse>c)||"number"==typeof i&&i>0&&function(e,t,i){if(t>=i.length)return!1;const{threshold:{bwe_down:s}}=i[t];return e<s}(i,l,a)&&(r.overUse++,u=te.BANDWIDTH,r.overUse>c)?(r.overUse=0,r.underUse=0,h=fi(s,a,o,Ti.DOWN),[h,u]):("number"==typeof t&&t>0&&"number"==typeof i&&i>0&&function(e,t,i,s){if(0===t)return;let{threshold:{fps_up:n}}=i[t];return w("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===s&&(n=i[1].threshold.fps_up),e>n}(t,l,a,o)&&function(e,t,i){if(0===t)return;const{threshold:{bwe_up:s}}=i[t];return e>s}(i,l,a)&&(r.underUse++,r.underUse>d&&(r.overUse=0,r.underUse=0,h=fi(s,a,o,Ti.UP),0===h.scale&&(u=te.NONE))),[h,u])}const gi=new Map;function Di(e,t){const i=gi.get(e);if(i){const{timer:t}=i;window.clearTimeout(t),gi.delete(e)}t.qualityLimitationReason=te.NONE,Ai(e)}var Ni;function Li(e,t,i){const s=e[t];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return await s.apply(this,o)}finally{i()}},i}function Pi(e,t){let i;switch(t){case et.LocalAudioTrack:i=Ye.Audio;break;case et.LocalVideoTrack:i=e._hints.includes(s.SCREEN_TRACK)?Ye.Screen:Ye.High;break;case et.LocalVideoLowTrack:i=Ye.Low}return i}var Oi,wi,bi,yi,Mi,ki,Ui,xi,Vi,Fi,Bi,Gi;Ni=class e extends Qe{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(ee).includes(e))))]}constructor(t,i){super(t,i),this.id=x(5,"connection-"),this.store=void 0,this.peerConnection=void 0,this.forceTurn=!1,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.extension={useXR:w("USE_XR")},this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.isPreallocation=!1,this.preSSRCMap=new Map,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.supportAV1RtpSpec=!1,this.mutex=void 0,this.qualityLimitationReason=te.NONE,this.isFirstConnected=!1,this.store=i,this.forceTurn=function(e){try{if(e.iceServers)return!1;if(e.turnServer&&"off"!==e.turnServer.mode){if(j(e.turnServer.servers))return!1;if(w("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some((e=>e.forceturn)))return!0}return!1}catch(e){return!1}}(t),this.mutex=new G("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=W(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,M()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){const t=this.preSSRCMap.get(e);if(void 0!==t){const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(e)return{transceiver:e,track:e.receiver.track,id:t}}}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,!this.remoteSDP)return void v.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t));if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else v.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const s=Tt(i.sdp),n=await Lt({filterRTX:!w("USE_PUB_RTX")&&!w("USE_SUB_RTX"),filterVideoFec:w("FILTER_VIDEO_FEC"),filterAudioFec:w("FILTER_AUDIO_FEC"),filterVideoCodec:w("FILTER_VIDEO_CODEC")},this.extension);if(this.localCapabilities=wt(n),this.initialOffer=i,w("ENABLE_SVC")&&"av1"==this.store.codec){const t=await async function(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:b.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const i=y(t.sdp).mediaDescriptions[0];if(!i)return;const s=i.attributes.extmaps.find((e=>"https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"===e.extensionName));return e.close(),s}catch(e){return}}();var e;if(t)this.supportAV1RtpSpec=!0,null===(e=n.send)||void 0===e||e.videoExtensions.push(t)}let o;return i.sdp&&Vt(i.sdp)&&(o=k(n),(t=o).send&&(_t(Ze.VIDEO,t.send.videoExtensions),_t(Ze.AUDIO,t.send.audioExtensions)),t.recv&&(_t(Ze.VIDEO,t.recv.videoExtensions),_t(Ze.AUDIO,t.recv.audioExtensions)),t.sendrecv&&(_t(Ze.VIDEO,t.sendrecv.videoExtensions),_t(Ze.AUDIO,t.sendrecv.audioExtensions))),Oe(Oe({},s),{},{rtpCapabilities:o||n,offerSDP:i.sdp})}catch(e){throw new H(K.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}var t}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&Vt(this.initialOffer.sdp)&&(t=e.rtpCapabilities,i=this.localCapabilities,t.send&&(Et(Ze.VIDEO,t.send.videoExtensions,i.send.videoExtensions),Et(Ze.AUDIO,t.send.audioExtensions,i.send.audioExtensions)),t.recv&&(Et(Ze.VIDEO,t.recv.videoExtensions,i.recv.videoExtensions),Et(Ze.AUDIO,t.recv.audioExtensions,i.recv.audioExtensions))),this.remoteSDP=new Ri(Oe(Oe({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString(),n=Ut(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(n||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s});const r=this.peerConnection.getTransceivers()[0];if(null!=r&&r.receiver&&this.tryBindTransportEvents(r.receiver),w("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(w("PRELOAD_MEDIA_COUNT"));const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}const{preSSRCs:a}=e;if(Array.isArray(a)&&a.length>0){const{mids:e}=this.remoteSDP.batchSend(a.map((e=>({kind:e.kind,ssrcMsg:[{ssrcId:e.ssrcId,rtx:e.rtx}],mslabel:e.mslabel}))));e.forEach(((e,t)=>{this.preSSRCMap.set(a[t].ssrcId,e)})),await kt(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}var t,i}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:t}=e;this.remoteSDP.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:i}=e;if(Array.isArray(i)&&i.length>0){const{mids:e}=this.remoteSDP.batchSend(i.map((e=>Object.assign({},{kind:e.kind,ssrcMsg:[{ssrcId:e.ssrcId,rtx:e.rtx}],mslabel:e.mslabel}))));e.forEach(((e,t)=>{this.preSSRCMap.set(i[t].ssrcId,e)}))}await kt(this.peerConnection,this.remoteSDP,this.extension),v.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(e.toString()))}}send(e,t,i){var s=this;return we((function*(){const n=yield Ne(s.mutex.lock("From P2PConnection.send"));try{if(!s.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],r=ut();e.forEach((e=>{const t=s.peerConnection.addTransceiver(e._mediaStreamTrack,Oe({direction:"sendonly"},"video"===e.trackMediaType&&s.supportAV1RtpSpec&&r?{sendEncodings:[{scalabilityMode:r}]}:{}));o.push(t),e._updateRtpTransceiver(t)})),M()&&!0===w("SIMULCAST")&&(yield Ne(s.applySimulcastForFirefox(o,e)));const a=yield Ne(s.peerConnection.createOffer()),c=s.remoteSDP.predictReceivingMids(e.length),d=s.mungSendOfferSDP(a.sdp,e,c),l=y(d),h=c.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Ct(t,w("USE_PUB_RTX"))}));let u;try{u=yield h}catch(n){u=[],s.remoteSDP.receive(e,t,i,u);const o=s.remoteSDP.toString();throw yield Ne(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Ne(s.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield Ne(s.stopSending(c,!0)),n}s.remoteSDP.receive(e,t,i,u);const p=s.remoteSDP.toString(),E=s.logSDPExchange(d,"offer","local","send");return yield Ne(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Ne(s.applySimulcastEncodings(o,e)),yield Ne(s.applySendEncodings(o,e)),null==E||E(p),yield Ne(s.peerConnection.setRemoteDescription({type:"answer",sdp:p})),o.map(((e,t)=>{const i=c[t];return{localSSRC:h[t],id:i,transceiver:e}}))}catch(e){throw e instanceof H?e:new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&"open"===i.readyState)v.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const t=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof t)throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:t,negotiated:!0,ordered:!1,maxRetransmits:w("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}t.forEach((e=>{e._updateOriginDataChannel(i)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t),v.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else v.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof H?e:new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof H?e:new H(K.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;Di(this.id+e.mid,this),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const s=await this.peerConnection.createOffer(),n=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==n||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:n,needExchangeSDP:o}=this.remoteSDP.send(e,t,i,s);o&&(await kt(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const r=this.peerConnection.getTransceivers().find((e=>e.mid===n));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:n,transceiver:r}}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await kt(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach((e=>{Array.from(this.preSSRCMap.entries()).some((t=>{let[i,s]=t;if(s===e)return this.preSSRCMap.delete(i),!0}))})),this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer();null==i||i(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer();null==i||i(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const s=await this.peerConnection.createAnswer();null==i||i(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),s=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const n=this.remoteSDP.toString();null==s||s(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),s=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString();null==s||s(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return we((function*(){const s=yield Ne(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const n=i().supportPCSetConfiguration,o=w("FORCE_TURN_TCP")||t.forceTurn;if(e===$e.RELAY&&!n)return;if(n&&!o){const i=e===$e.RELAY?"relay":"all",s=t.peerConnection.getConfiguration();s.iceTransportPolicy!==i&&(v.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(s.iceTransportPolicy,"] to [").concat(i,"]")),s.iceTransportPolicy=i,t.peerConnection.setConfiguration(s))}t.remoteSDP.updateCandidates(e);const r=yield Ne(t.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=Tt(r.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);const d=t.remoteSDP.toString(),l=t.logSDPExchange(r.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield Ne(t.peerConnection.setLocalDescription(r)),null==l||l(d),yield Ne(t.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(e){v.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{s()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const e=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates($e.TCP_RELAY),await kt(this.peerConnection,this.remoteSDP,this.extension)}catch(e){v.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),e)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{Di(this.id+e.mid,this)})),this.preSSRCMap.clear(),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Oe(Oe({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const n=this.remoteSDP.toString(),o=this.logSDPExchange(s,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),null==o||o(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new H(K.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?M()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:s}=t.getSelectedCandidatePair();return{local:Oe(Oe({},q),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Oe(Oe({},q),{},{candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.isFirstConnected=!0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var t;const i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),s=e.port?"local: ".concat(e.port):"";v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(e.url||"",", host_candidate:").concat(s)),null===(t=this.onICECandidateError)||void 0===t||t.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),w("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const s={iceServers:[]};return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&(j(t.turnServer.servers)?s.iceServers=t.turnServer.servers:w("NEW_TURN_MODE")&&s.iceServers?(w("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&s.iceServers.push(...e.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):s.iceServers.push(...e.newTurnServerConfigToIceServers(t.turnServer.servers)),w("NEW_FORCE_TURN")&&(s.iceTransportPolicy="relay")):"off"!==t.turnServer.mode&&(s.iceServers&&s.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),w("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),w("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(s.iceTransportPolicy="relay")})))),w("ENABLE_ENCODED_TRANSFORM")&&i().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),s}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(ct(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!w("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}static newTurnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{const i=w("NEW_TURN_MODE");1===i?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}):2===i?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}):3===i?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(ct(e.turnServerURL),":443?transport=tcp")}):4===i&&(t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(ct(e.turnServerURL),":443?transport=tcp")}))})),t}tryBindTransportEvents(e){const t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var e;null!=t&&t.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,t.state))},t.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=t.iceTransport;i&&(i.onstatechange=()=>{const e=null==t?void 0:t.iceTransport.state;var i;e&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,e))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:e,remote:t}=i.getSelectedCandidatePair();v.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol,address:t.address,port:t.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n;if(!t){const i=this.peerConnection.getSenders();t=i.find((t=>t.track===e._mediaStreamTrack))}if(!t)return v.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return v.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!i().supportSetRtpSenderParameters)return v.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},r={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const a=function(e,t){return e.getTransceivers().find((e=>e.sender.track===t||e.receiver.track===t))}(this.peerConnection,e._mediaStreamTrack),c=m(e);if(function(e){return!(!w("ENABLE_AG_ADAPTATION")||!(e instanceof S||e._hints.includes(s.CUSTOM_TRACK))||!w("FORCE_SUPPORT_AG_ADAPTATION")&&!(se(14)&&ne(17,4,!0)||oe(14)&&re(17,4,!0)))}(e)&&a&&t&&c&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const i=o.degradationPreference||(e._hints.includes(s.CUSTOM_TRACK)?w("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(e,t,i,s,n,o){if(Di(e,i),n(t),"balanced"!==s&&"maintain-framerate"!==s&&"maintain-resolution"!==s)return;let r=-1;Ai(e,t);const a=window.setInterval((()=>{const a=gi.get(e);if(!w("ENABLE_AG_ADAPTATION")||!a)return Di(e,i),void n(t);const c=o();if(c.sendPackets>0&&c.OutgoingAvailableBandwidth>0){if(-1===r)return void(r=Date.now());if(Date.now()-r<1e3)return;const o=c.sendFrameRate,d=c.OutgoingAvailableBandwidth,[l,h]=vi(e,o,d,a.adaptationConfig,t,s);h&&(i.qualityLimitationReason=h),l&&a.adaptationConfig.scale!==l.scale&&(v.debug("[".concat(e,"] applyAdaptation: ").concat(i.qualityLimitationReason,"\n           sendFps ").concat(o,", bwe ").concat(d,", switch from ").concat(a.adaptationConfig.scale," to ").concat(l.scale," ")),a.adaptationConfig=Oe(Oe({},a.adaptationConfig),l),n(l))}}),w("CHECK_LOCAL_STATS_INTERVAL")),c=Oe({},t);gi.set(e,{timer:a,adaptationConfig:c,originConfig:t,adaptationFunc:n}),v.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(s))}(this.id+a.mid,c,this,i,(e=>{t&&this.updateAdaptation(t,e)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(r.maxBitrate=1e3*t),(e._hints.includes(s.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(i&&(r.maxFramerate=dt(i)),n&&n>=1&&(r.scaleResolutionDownBy=n))}const{maxFramerate:d}=w("ENCODER_CONFIG_LIMIT");if(d&&"number"==typeof d&&(r.maxFramerate=r.maxFramerate?Math.min(r.maxFramerate,d):d),w("DSCP_TYPE")&&J()){const e=w("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(r.networkPriority=e)}const l=t.getParameters(),h=null===(n=l.encodings)||void 0===n?void 0:n[0];M()&&!h&&(o.encodings=[r]),h&&Object.assign(h,r),Object.assign(l,o),v.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await t.setParameters(l),await async function(e,t,s){try{var n;if(!i().supportSetRtpSenderParameters)return;if(!function(e){return"vp9"===e||"av1"===e}(e)||!w("ENABLE_SVC"))return;const o={},r={},a=t.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];r.scalabilityMode=ut(s),c&&Object.assign(c,r),Object.assign(a,o),await t.setParameters(a),v.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(a.encodings)))}catch(e){v.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",e)}}(this.store.codec,t,w("SVC_MODE"))}async updateAdaptation(e,t){var s;if(!e)return v.debug("[updateAdaptation] no rtpSender found");if(!i().supportSetRtpSenderParameters)return v.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const n={},{bitrateMax:o,frameRate:r,scaleResolutionDownBy:a}=t;o&&(n.maxBitrate=1e3*o),r&&(n.maxFramerate=dt(r)),a&&a>=1&&["vp8","vp9"].includes(this.store.codec)&&(n.scaleResolutionDownBy=a);const c=e.getParameters(),d=null===(s=c.encodings)||void 0===s?void 0:s[0];d&&Object.assign(d,n),Object.assign(c,{});try{await e.setParameters(c),v.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(t){!("transport"in e)||e.transport&&"connected"===e.transport.state?"connected"!==this.peerConnectionState?v.debug("[updateAdaptation] peerConnection not connected}"):v.debug("[updateAdaptation] updateRtpSenderEncodings failed",t):v.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,s){try{if(!i().supportSetRtpSenderParameters)return;if(e.length!==s.length)return;for(let i=0;i<e.length;i++){const n=e[i],o=s[i];o instanceof t&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,n.sender)}}catch(e){v.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const s=y(e);return t.forEach(((e,t)=>{const n=i[t],o=s.mediaDescriptions.find((e=>e.attributes.mid===n));o&&(At(o,e),Nt(o,e,this.store.codec))})),U(s)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var s;null===(s=this.onFirstVideoDecoded)||void 0===s||s.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,o,r,a;const d=e[c],l=i[c];if(l instanceof t&&!l._hints.includes(s.LOW_STREAM)&&null!==(n=l._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(o=l._encoderConfig)||void 0===o?void 0:o.bitrateMax)>200&&null!==(r=l._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(a=l._scalabilityMode)||void 0===a?void 0:a.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=d.sender.getParameters();await d.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,i){if(!M()&&e.length===i.length)for(let s=0;s<e.length;s++){const n=i[s];if(n instanceof t&&this.isVP8Simulcast(n)){const t=e[s],i={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};i.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,i))}}}isVP8Simulcast(e){var i,n,o,r;return!!(e instanceof t&&w("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(s.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(o=e._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=e._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1)}logSDPExchange(e,t,i,s){if(w("SDP_LOGGING"))return v.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return t&&0!==t.length?t[0].ssrcId:void 0}setConfiguration(t){if(i().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},De(Ni.prototype,"updateRemoteRTPCapabilities",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"updateRemoteRTPCapabilities"),Ni.prototype),De(Ni.prototype,"connect",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"connect"),Ni.prototype),De(Ni.prototype,"updateRemoteConnect",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"updateRemoteConnect"),Ni.prototype),De(Ni.prototype,"createDataChannels",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"createDataChannels"),Ni.prototype),De(Ni.prototype,"receive",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"receive"),Ni.prototype),De(Ni.prototype,"batchReceive",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"batchReceive"),Ni.prototype),De(Ni.prototype,"stopReceiving",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"stopReceiving"),Ni.prototype),De(Ni.prototype,"muteRemote",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"muteRemote"),Ni.prototype),De(Ni.prototype,"unmuteRemote",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"unmuteRemote"),Ni.prototype),De(Ni.prototype,"muteLocal",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"muteLocal"),Ni.prototype),De(Ni.prototype,"unmuteLocal",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"unmuteLocal"),Ni.prototype),De(Ni.prototype,"close",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"close"),Ni.prototype),De(Ni.prototype,"updateEncoderConfig",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"updateEncoderConfig"),Ni.prototype),De(Ni.prototype,"updateSendParameters",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"updateSendParameters"),Ni.prototype),De(Ni.prototype,"replaceTrack",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"replaceTrack"),Ni.prototype),De(Ni.prototype,"updateAdaptation",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"updateAdaptation"),Ni.prototype),De(Ni.prototype,"getRemoteSSRC",[Li],Object.getOwnPropertyDescriptor(Ni.prototype,"getRemoteSSRC"),Ni.prototype),!i().supportUnifiedPlan||w("CHROME_FORCE_PLAN_B")&&J();let Wi=(Oi=Hi(_i.SEND_ONLY),wi=Hi(_i.SEND_ONLY),bi=Hi(),yi=Hi(_i.RECEIVE_ONLY),Mi=Hi(_i.RECEIVE_ONLY),ki=Hi(_i.RECEIVE_ONLY),Ui=Hi(_i.RECEIVE_ONLY),xi=Hi(_i.RECEIVE_ONLY),Vi=Hi(_i.RECEIVE_ONLY),Fi=Hi(),Bi=Hi(_i.RECEIVE_ONLY),De((Gi=class extends O{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(it.StateChange,t,this._state)}constructor(e,t){super(),this.isPlanB=!1,this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=void 0,this.recvMutex=void 0,this._state=tt.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==tt.Connected)return void i(new H(K.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const r=this.filterTobeMutedTracks(e);if(0===r.length)return void t();const a=r.find((e=>"videoLowTrack"===e[0]));if(a){a[1].track._originMediaStreamTrack.stop()}await this.sendConnection.muteLocal(r.map((e=>{let[,{id:t}]=e;return t})));let c=!1;var n,o;if("video"===e.trackMediaType)c=!(null===(n=this.localTrackMap.get(et.LocalAudioTrack))||void 0===n||!n.track._muted);else c=void 0===(null===(o=this.localTrackMap.get(et.LocalVideoTrack))||void 0===o?void 0:o.id);const d=this.createMuteMessage(r);await ae(this,it.RequestMuteLocal,d);const l="video"===e.trackMediaType?rt.MUTE_LOCAL_VIDEO:rt.MUTE_LOCAL_AUDIO;await ae(this,it.RequestP2PMuteLocal,{action:l,message:d,isMuteAll:c}),t()}catch(e){i(e)}finally{s()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==tt.Connected)return void i(new H(K.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const n=this.filterTobeUnmutedTracks(e);if(0===n.length)return void t();await this.sendConnection.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(n),r="video"===e.trackMediaType?rt.UNMUTE_LOCAL_VIDEO:rt.UNMUTE_LOCAL_AUDIO;await ae(this,it.RequestP2PMuteLocal,{action:r,message:o}),t()}catch(e){i(e)}finally{s()}},this.handleUpdateVideoEncoder=async(e,t,i,s)=>{let n;"boolean"==typeof s&&s||(n=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const i=this.localTrackMap.get(et.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==tt.Connected)return void t();const{id:s,track:r}=i;s&&(await this.sendConnection.updateSendParameters(s,r),await this.sendConnection.updateEncoderConfig(s,r),this.emit(it.UpdateVideoEncoder,r)),t()}catch(e){i(e)}finally{var o;null===(o=n)||void 0===o||o()}},this.handleUpdateVideoSendParameters=async(e,t,i)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const i=this.localTrackMap.get(et.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==tt.Connected)return void t();const{id:n,track:o}=i;n&&await this.sendConnection.updateSendParameters(n,o),t()}catch(e){i(e)}finally{s()}},this.handleReplaceTrack=async(e,t,s,n)=>{let o;v.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof n&&n||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var r;const s=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!s||void 0===s[1].id||this.state!==tt.Connected)return void t();if(await(null===(r=this.sendConnection)||void 0===r?void 0:r.replaceTrack(e,s[1].id)),s[0]===et.LocalVideoTrack&&i().supportDualStreamEncoding){const t=this.localTrackMap.get(et.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}t()}catch(e){s(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new pi(e),this.bindStatsUploaderEvents(),this.sendMutex=new G("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new G("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),w("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new H(K.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new H(K.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let i;try{if(t){this.recvConnection&&(v.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Ht(e,this.store,He.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const s=await this.recvConnection.establish(t);return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}{this.state=tt.New,this.sendConnection&&(v.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Ht(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const t=await this.sendConnection.establish();return{iceParameters:t.iceParameters,dtlsParameters:t.dtlsParameters,sdp:t.sdp}}}finally{i&&i()}}async p2pConnect(e){if(!this.sendConnection)throw new H(K.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=tt.Connected}async addRemoteCandidate(e,t){if(t===He.RECEIVE_ONLY){if(!this.sendConnection)throw new H(K.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new H(K.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var s=this;return we((function*(){const n=yield Ne(s.sendMutex.lock("From P2PChannel.publish"));try{if(!s.sendConnection||s.state!==tt.Connected){s.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===s.pendingLocalTracks.indexOf(e)));return void(s.pendingLocalTracks=s.pendingLocalTracks.concat(t))}s.store.pubId=s.store.pubId+1,Yt.markPublishStart(s.store.clientId,s.store.pubId);const o=s.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield Ne(s.tryToUnmuteAudio(e)));o.forEach((e=>{let{track:t,type:i}=e;const n=Date.now();s.store.publish(t.getTrackId(),i===et.LocalAudioTrack?"audio":"video",n)})),s.bindLocalTrackEvents(o);const r=yield Ne(s.sendConnection.send(o.map((e=>{let{track:t}=e;return t})),s.store.codec,s.store.audioCodec)),a=(yield Ne(r.next())).value,c=s.createGatewayPublishMessage(o,a);try{yield c}catch(e){throw r.throw(e),(null==e?void 0:e.code)===K.WS_ABORT&&o.forEach((e=>{let{track:t}=e;-1===s.pendingLocalTracks.indexOf(t)&&s.pendingLocalTracks.push(t)})),s.unbindLocalTrackEvents(o),e}yield Ne(r.next()),o.forEach((e=>{let{type:t}=e;s.statsCollector.addLocalStats(t)})),s.statsUploader.startUploadOutboundStats(),s.assignLocalTracks(o,a),o.forEach((e=>{let{track:t,type:i}=e;const n=Date.now();s.store.publish(t.getTrackId(),i===et.LocalAudioTrack?"audio":"video",void 0,n)})),s.startUploadUplinkState()}finally{n()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==tt.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!e.includes(t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}const s=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===tt.Connected){if(i){i[1].track.close()}return s}e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[s,{track:n,ssrcs:o}]=i;const r={stream_type:Pi(n,s),ssrcs:o};n._muted||!n._enabled?e.push(r):t.push(r)})),e.length>0&&e.forEach((e=>{ae(this,it.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{ae(this,it.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return we((function*(){throw new H(K.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(v.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await ce(this,it.RequestRePublish,this.pendingLocalTracks),this.emit(it.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new H(K.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,i,s){var n;if(!this.recvConnection)throw new H(K.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(n=this.remoteUserMap.get(e))&&void 0!==n&&n.has(t))return;const{track:o,mid:r,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:i}],String(e.uid),s);t===Ze.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new R(o,e.uid,e._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=i,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new T(o,e.uid,e._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,r):this.remoteUserMap.set(e,new Map([[t,r]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex((i=>{let{user:s,kind:n}=i;return s.uid===e.uid&&t===n}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(it.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,s){if(!this.recvConnection)throw new H(K.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),s)}async unsubscribe(e,t,i){const s=this.pendingRemoteTracks.filter((i=>{let{user:s,kind:n}=i;return void 0!==t?s.uid===e.uid&&t===n:s.uid===e.uid}));if(s.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||i||s.forEach((t=>{let{kind:i}=t;var s;if(i===Ze.AUDIO)null===(s=e._audioTrack)||void 0===s||s._destroy(),e._audioTrack=void 0;else if(i===Ze.VIDEO){var n;null===(n=e._videoTrack)||void 0===n||n._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const n=this.filterTobeUnSubscribedTracks(e,t);0!==n.length&&(await this.recvConnection.stopReceiving(n.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(n),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),n.forEach((e=>{let[t,{kind:s}]=e;var n,o;s===Ze.VIDEO&&t._videoSSRC&&(null===(n=this.recvConnection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(s===Ze.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(s===Ze.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),n.forEach((e=>{let[,{kind:t}]=e;ae(this,it.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[Ze.VIDEO,Ze.AUDIO].forEach((e=>{t.has(e)?ae(this,it.RequestP2PUnmuteRemote,e):ae(this,it.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new H(K.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new H(K.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new H(K.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new H(K.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);if(!i)return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const s=t===Ze.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);if(!i)return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));i.get(t)||v.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(et.LocalAudioTrack);if((null==t?void 0:t.track)instanceof o){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==et.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===et.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===et.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(i,n,o,r,a){if(i){const e=this.localTrackMap.get(et.LocalAudioTrack),t=r?this.localTrackMap.get(et.LocalVideoLowTrack):this.localTrackMap.get(et.LocalVideoTrack);D.publish(this.store.sessionId,{eventElapse:Yt.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:i,ec:n,audioName:null==e?void 0:e.track.getTrackLabel(),videoName:null==t?void 0:t.track.getTrackLabel(),screenshare:-1!==(null==t?void 0:t.track._hints.indexOf(s.SCREEN_TRACK)),audio:!!e,video:!!t,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}else{var c;o||(o=[]);const d=o.find((t=>t instanceof e)),l=r?null===(c=this.localTrackMap.get(et.LocalVideoTrack))||void 0===c?void 0:c.track:o.find((e=>e instanceof t));D.publish(this.store.sessionId,{eventElapse:Yt.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:i,ec:n,audioName:null==d?void 0:d.getTrackLabel(),videoName:null==l?void 0:l.getTrackLabel(),screenshare:-1!==(null==l?void 0:l._hints.indexOf(s.SCREEN_TRACK)),audio:!!d,video:!!l,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}}reportSubscribeEvent(e,t,i,s){const n=s===Ze.VIDEO?i._videoSSRC:i._audioSSRC;n&&D.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Ze.VIDEO,audio:s===Ze.AUDIO,peerid:i.uid,subscribeRequestid:s===Ze.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:Yt.measureFromSubscribeStart(this.store.clientId,n)})}reset(){v.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new G("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new G("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(et.LocalAudioTrack);if((null==e?void 0:e.track)instanceof o){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=tt.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(et.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(et.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(i){const s=this.localTrackMap.get(i);return s&&s.track instanceof t||s&&s.track instanceof e?s.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(et.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(v.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=tt.Reconnecting,w("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case et.LocalVideoTrack:i._hints.includes(s.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case et.LocalAudioTrack:i instanceof o?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case et.LocalVideoLowTrack:}})),this.emit(it.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(it.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),v.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:s,kind:n}=i;if((e instanceof Ei?e.uid:e)===s.uid&&t===n)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,s;if(e===He.SEND_ONLY){if(!this.sendConnection)throw new H(K.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),s=this.sendConnection}else{if(!this.recvConnection)throw new H(K.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),s=this.recvConnection}try{if(t){const e=await s.restartICE(t);return s.isInRestartIce=!1,e}{const e=await s.restartICE();if(e){const t=await ce(this,it.RequestP2PRestartICE,{direction:He.RECEIVE_ONLY,iceParameter:e});await s.restartICE(t),s.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(et.LocalVideoTrack),i=this.localTrackMap.get(et.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),o=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!o)return 1;const r=de(this,it.NeedSignalRTT),a=n?n.rttMs:void 0,c=o?o.rttMs:void 0,d=a&&c?(a+c)/2:a||c,l=(d&&r?(d+r)/2:d||r)||0,h=100*e.sendPacketLossRate*.7/50+.3*l/1500,u=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,p=null==t?void 0:t.track;if(p&&p._encoderConfig&&-1===p._hints.indexOf(s.SCREEN_TRACK)){const t=p._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return je[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[s]=i;const n=s._audioSSRC,o=s._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===n)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=de(this,it.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(s,n,r){const a=[],c=i(),d=this.getAllTracks();s=s.filter((e=>-1===d.indexOf(e))),s=le(s);let l=!1,h=!1;for(const i of s){if(i instanceof t&&(this.localTrackMap.has(et.LocalVideoTrack)||l?new H(K.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(a.push({track:i,type:et.LocalVideoTrack}),l=!0),n)){const e=this.getLowVideoTrack(i,r);a.push({track:e,type:et.LocalVideoLowTrack})}if(i instanceof e){const e=this.localTrackMap.get(et.LocalAudioTrack);if(e){if(!(e.track instanceof o))throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(i._bypassWebAudio)throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(i),this.bindLocalAudioTrackEvents(i,!0)}else if(h){const e=a.find((e=>{let{type:t}=e;return t===et.LocalAudioTrack}));if(!(e.track instanceof o))throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(i._bypassWebAudio)throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(i)}else{if(!c.webAudioMediaStreamDest||i instanceof o||i._bypassWebAudio)a.push({track:i,type:et.LocalAudioTrack});else{const e=new o;e.addAudioTrack(i),a.push({track:e,type:et.LocalAudioTrack})}h=!0}}}return a}filterTobeUnpublishedTracks(i){const s=[],n=this.getAllTracks();i=i.filter((e=>-1!==n.indexOf(e))),i=le(i);for(const n of i){if(n instanceof e){const e=this.localTrackMap.get(et.LocalAudioTrack);if(!e)continue;e.track instanceof o?(e.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),0===e.track.trackList.length&&(s.push([et.LocalAudioTrack,e]),e.track.close())):s.push([et.LocalAudioTrack,e])}if(n instanceof t){const e=this.localTrackMap.get(et.LocalVideoTrack);if(!e)continue;s.push([et.LocalVideoTrack,e]);const t=this.localTrackMap.get(et.LocalVideoLowTrack);t&&s.push([et.LocalVideoLowTrack,t])}}return s}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case et.LocalVideoTrack:t.addListener(C.GET_STATS,this.handleGetLocalVideoStats),t.addListener(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(C.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(C.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(C.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case et.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case et.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof o?e.trackList.forEach((e=>{e.addListener(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(C.GET_STATS,this.handleGetLocalAudioStats),e.addListener(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(C.GET_STATS,this.handleGetLocalAudioStats),e.addListener(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(C.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case et.LocalVideoTrack:t.off(C.GET_STATS,this.handleGetLocalVideoStats),t.off(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(C.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(C.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(C.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case et.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case et.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof o?e.trackList.forEach((e=>{e.off(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(C.GET_STATS,this.handleGetLocalAudioStats),e.off(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(C.GET_STATS,this.handleGetLocalAudioStats),e.off(C.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(C.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(C.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(C.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(C.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof T&&t.addListener(C.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof R&&t.addListener(C.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(C.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Ze.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Ze.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,{track:o,type:r}=e;switch(r){case et.LocalAudioTrack:n=Ye.Audio;break;case et.LocalVideoTrack:n=o._hints.includes(s.SCREEN_TRACK)?Ye.Screen:Ye.High;break;case et.LocalVideoLowTrack:n=Ye.Low}return{kind:r===et.LocalAudioTrack?Ze.AUDIO:Ze.VIDEO,stream_type:n,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:o,id:r}]=e;switch(i){case et.LocalVideoTrack:t=n._hints.includes(s.SCREEN_TRACK)?Ye.Screen:Ye.High;break;case et.LocalAudioTrack:t=Ye.Audio;break;case et.LocalVideoLowTrack:t=Ye.Low}return{stream_type:t,ssrcs:o,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:s,type:n}=e;this.localTrackMap.set(n,{track:s,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(it.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(e.isInRestartIce=!1),this._restartStates.includes(t)&&!e.isInRestartIce&&("disconnected"===t&&await he(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),D.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ue.TRACER}).onSuccess(),this.emit(it.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var i;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=t.audioTrack)||void 0===i||i.emit(f.FIRST_FRAME_DECODED),D.firstRemoteFrame(this.store.sessionId,N.FIRST_AUDIO_DECODE,L.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:Yt.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&D.firstRemoteFrame(this.store.sessionId,N.FIRST_AUDIO_RECEIVED,L.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:Yt.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&D.firstRemoteFrame(this.store.sessionId,N.FIRST_VIDEO_RECEIVED,L.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:Yt.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const i="relay"===e.candidateType,s="relay"===t.candidateType;"unknown"!==t.candidateType&&i===s||this.emit(it.ConnectionTypeChange,i),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ht(t))," -> ").concat(JSON.stringify(ht(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ht(t))," -> ").concat(JSON.stringify(ht(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(it.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===He.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,v.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===He.SEND_ONLY?this.restartICE(e):ce(this,it.RequestP2PRestartICE,{direction:He.SEND_ONLY}))}filterTobeMutedTracks(t){const i=[];if(-1===this.getAllTracks().indexOf(t))return i;const s=this.localTrackMap.get(et.LocalAudioTrack);if(t instanceof e&&(null==s?void 0:s.track)instanceof o)return s.track.isActive||i.push([et.LocalAudioTrack,s]),i;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n&&(i.push(n),n[0]===et.LocalVideoTrack)){const e=this.localTrackMap.get(et.LocalVideoLowTrack);e&&i.push([et.LocalVideoLowTrack,e])}return i}filterTobeUnmutedTracks(t){const i=[],s=this.localTrackMap.get(et.LocalAudioTrack);if(t instanceof e&&(null==s?void 0:s.track)instanceof o)return s.track.isActive&&i.push([et.LocalAudioTrack,s]),i;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n)if(n[0]===et.LocalVideoTrack){i.push(n);const e=this.localTrackMap.get(et.LocalVideoLowTrack);e&&i.push([et.LocalVideoLowTrack,e])}else i.push(n);return i}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:o,id:r}]=e;switch(i){case et.LocalAudioTrack:t=Ye.Audio;break;case et.LocalVideoTrack:t=n._hints.includes(s.SCREEN_TRACK)?Ye.Screen:Ye.High;break;case et.LocalVideoLowTrack:t=Ye.Low}return{stream_type:t,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:o,id:r}]=e;switch(i){case et.LocalAudioTrack:t=Ye.Audio;break;case et.LocalVideoTrack:t=n._hints.includes(s.SCREEN_TRACK)?Ye.Screen:Ye.High;break;case et.LocalVideoLowTrack:t=Ye.Low}return{stream_type:t,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],s=this.remoteUserMap.get(e);if(!s)return i;if(t){const n=s.get(t);if(!n)return i;i.push([e,{kind:t,id:n}])}else Array.from(s.entries()).forEach((t=>{let[s,n]=t;i.push([e,{kind:s,id:n}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:s,id:n}]=e;switch(s){case Ze.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Ze.VIDEO,ssrcId:i._videoSSRC}));case Ze.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Ze.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const s=this.remoteUserMap.get(t);s&&(s.delete(i),0===Array.from(s.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(et.LocalVideoTrack),i=this.localTrackMap.get(et.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new Promise(((e,i)=>{this.handleUpdateVideoEncoder(t.track,e,i,!0)}))),i&&e.low_stream_uplink&&(await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new Promise(((e,t)=>{this.handleUpdateVideoEncoder(i.track,e,t,!0)})))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof e){const e=this.filterTobeUnmutedTracks(t[i]);if(0===e.length)continue;const s=this.createUnmuteMessage(e);return void await ae(this,it.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(it.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(it.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await he(pe(this.dtlsFailedCount,Ee)),this.emit(it.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(et.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof t))}throwIfTrackTypeNotMatch(s){if(s.filter((e=>e instanceof t)).length>1)throw new H(K.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(s.filter((t=>t instanceof e)).length>1&&(s.some((t=>t instanceof e&&t._bypassWebAudio))||!i().webAudioMediaStreamDest))throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const n of s){if(n instanceof t&&this.pendingLocalTracks.some((e=>e instanceof t)))throw new H(K.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(n instanceof e&&this.pendingLocalTracks.some((t=>t instanceof e))&&(!i().webAudioMediaStreamDest||n._bypassWebAudio||this.pendingLocalTracks.some((t=>t instanceof e&&t._bypassWebAudio))))throw new H(K.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,o){const r=!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&i().supportDualStreamEncoding,a=Oe(Oe({},{width:160,height:120,framerate:15,bitrate:50}),o);let c;c=r?e._mediaStreamTrack.clone():function(e,t){let s=document.createElement("video"),o=document.createElement("canvas");s.setAttribute("style","display:none"),o.setAttribute("style","display:none"),s.setAttribute("muted",""),s.muted=!0,s.setAttribute("autoplay",""),s.autoplay=!0,s.setAttribute("playsinline",""),o.width=dt(t.width),o.height=dt(t.height);const r=dt(t.framerate||15);document.body.append(s),document.body.append(o);let a=e._mediaStreamTrack;s.srcObject=new MediaStream([a]),s.play();const c=o.getContext("2d");if(!c)throw new g(K.UNEXPECTED_ERROR,"can not get canvas context");const d=i(),l=o.captureStream(d.supportRequestFrame?0:r).getVideoTracks()[0];l.canvas||(l.canvas=o),o.startCapture=()=>{if(!s)return o.stopCapture&&o.stopCapture();if(s.paused&&s.play(),s.videoHeight>2&&s.videoWidth>2){const e=s.videoWidth,t=s.videoHeight/e,i=o.width*t;Math.abs(i-o.height)>=2&&(v.debug("adjust low stream resolution","".concat(o.width,"x").concat(o.height," -> ").concat(o.width,"x").concat(i)),o.height=i)}c.drawImage(s,0,0,o.width,o.height),l.requestFrame&&l.requestFrame(),a!==e._mediaStreamTrack&&(a=e._mediaStreamTrack,s.srcObject=new MediaStream([a]))},o.stopCapture=n((()=>o.startCapture&&o.startCapture()),r);const h=l.stop;return l.stop=()=>{h.call(l),s&&(s.remove(),s.srcObject=null,s=null),o&&(o.width=0,o.remove(),o.stopCapture&&o.stopCapture(),o.startCapture=void 0,o.stopCapture=void 0,o=null),v.debug("clean low stream renderer")},l}(e,a);const d=x(8,"track-low-"),l=new t(c,Oe(Oe({},r&&{scaleResolutionDownBy:lt(a,e)}),{},{frameRate:a.framerate,bitrateMax:a.bitrate,bitrateMin:a.bitrate}),void 0,void 0,d);return l.on(A.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,I.LOW_STREAM)})),l._hints.push(s.LOW_STREAM),e.addListener(C.NEED_CLOSE,(()=>{l.close()})),l}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,i,s){const n=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(n){s||this.store.subscribe(n.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,r=o.subscribe.find((e=>e.userId===n.uid&&"video"===e.type));D.firstRemoteVideoDecode(this.store.sessionId,N.FIRST_VIDEO_DECODE,L.FIRST_VIDEO_DECODE,{peer:n._uintid,videowidth:t,videoheight:i,subscribeElapse:Yt.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(null==r?void 0:r.subscribeEnd)||0,subscriberStart:(null==r?void 0:r.subscribeStart)||0,videoAddNotify:(null==r?void 0:r.streamAdded)||0,state:s?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const s=this.remoteUserMap.get(e);if(!s)return!1;const n=s.get(t);if(!n)return!1;const o=await this.recvConnection.getRemoteSSRC(n);return void 0!==o&&o!==i}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new H(K.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new H(K.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new H(K.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new H(K.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new H(K.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new H(K.NOT_SUPPORTED)}async preConnect(e){throw new H(K.NOT_SUPPORTED)}getEstablishParams(){throw new H(K.NOT_SUPPORTED)}async reSubscribe(e){throw new H(K.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new H(K.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===et.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,I.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}).prototype,"p2pConnect",[Oi],Object.getOwnPropertyDescriptor(Gi.prototype,"p2pConnect"),Gi.prototype),De(Gi.prototype,"unpublish",[wi],Object.getOwnPropertyDescriptor(Gi.prototype,"unpublish"),Gi.prototype),De(Gi.prototype,"unpublishLowStream",[bi],Object.getOwnPropertyDescriptor(Gi.prototype,"unpublishLowStream"),Gi.prototype),De(Gi.prototype,"subscribe",[yi],Object.getOwnPropertyDescriptor(Gi.prototype,"subscribe"),Gi.prototype),De(Gi.prototype,"mockSubscribe",[Mi],Object.getOwnPropertyDescriptor(Gi.prototype,"mockSubscribe"),Gi.prototype),De(Gi.prototype,"unsubscribe",[ki],Object.getOwnPropertyDescriptor(Gi.prototype,"unsubscribe"),Gi.prototype),De(Gi.prototype,"muteRemote",[Ui],Object.getOwnPropertyDescriptor(Gi.prototype,"muteRemote"),Gi.prototype),De(Gi.prototype,"unmuteRemote",[xi],Object.getOwnPropertyDescriptor(Gi.prototype,"unmuteRemote"),Gi.prototype),De(Gi.prototype,"hasRemoteMediaWithLock",[Vi],Object.getOwnPropertyDescriptor(Gi.prototype,"hasRemoteMediaWithLock"),Gi.prototype),De(Gi.prototype,"disconnectForReconnect",[Fi],Object.getOwnPropertyDescriptor(Gi.prototype,"disconnectForReconnect"),Gi.prototype),De(Gi.prototype,"remoteMediaSsrcChanged",[Bi],Object.getOwnPropertyDescriptor(Gi.prototype,"remoteMediaSsrcChanged"),Gi.prototype),Gi);function Hi(e){return function(t,i,s){const n=t[i];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return s.value=async function(){for(var t=arguments.length,s=new Array(t),o=0;o<t;o++)s[o]=arguments[o];switch(e){case _i.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,s)}finally{e()}}case _i.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,s)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,s)}finally{e(),t()}}}},s}}ye.ACCESS_POINT,Ue.NO_FLAG_SET,Ue.FLAG_SET_BUT_EMPTY,Ue.INVALID_FALG_SET,Ue.FLAG_SET_BUT_NO_RE,Ue.INVALID_SERVICE_ID,Ue.NO_SERVICE_AVAILABLE,Ue.NO_SERVICE_AVAILABLE_P2P,Ue.NO_SERVICE_AVAILABLE_VOICE,Ue.NO_SERVICE_AVAILABLE_WEBRTC,Ue.NO_SERVICE_AVAILABLE_CDS,Ue.NO_SERVICE_AVAILABLE_CDN,Ue.NO_SERVICE_AVAILABLE_TDS,Ue.NO_SERVICE_AVAILABLE_REPORT,Ue.NO_SERVICE_AVAILABLE_APP_CENTER,Ue.NO_SERVICE_AVAILABLE_ENV0,Ue.NO_SERVICE_AVAILABLE_VOET,Ue.NO_SERVICE_AVAILABLE_STRING_UID,Ue.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS,ye.UNILBS,ke.INVALID_VENDOR_KEY,ke.INVALID_CHANNEL_NAME,ke.INTERNAL_ERROR,ke.NO_AUTHORIZED,ke.DYNAMIC_KEY_TIMEOUT,ke.NO_ACTIVE_STATUS,ke.DYNAMIC_KEY_EXPIRED,ke.STATIC_USE_DYNAMIC_KEY,ke.DYNAMIC_USE_STATIC_KEY,ke.USER_OVERLOAD,ke.FORBIDDEN_REGION,ke.CANNOT_MEET_AREA_DEMAND,ye.STRING_UID_ALLOCATOR,Me.IIIEGAL_APPID,Me.IIIEGAL_UID,Me.INTERNAL_ERROR;const Ki={[xe.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[xe.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[xe.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[xe.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[xe.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[xe.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[xe.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[xe.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[xe.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[xe.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[xe.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[xe.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[xe.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[xe.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[xe.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[xe.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[xe.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[xe.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[xe.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[xe.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[xe.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[xe.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[xe.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[xe.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[xe.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[xe.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[xe.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[xe.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[xe.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[xe.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[xe.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[xe.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[xe.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[xe.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[xe.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[xe.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[xe.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[xe.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[xe.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[xe.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[xe.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[xe.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[xe.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[xe.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[xe.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[xe.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[xe.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[xe.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[xe.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[xe.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[xe.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[xe.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[xe.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[xe.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[xe.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[xe.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[xe.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[xe.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[xe.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[xe.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[xe.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[xe.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[xe.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[xe.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Yi(e){const t=Ki[e];return t||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}class qi extends O{constructor(e,t){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=e,this.token=t;const i=()=>{this.signal.connectionState===Ve.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*w("P2P_TOKEN_INTERVAL"))};i()}async send(e,t,i,s,n){var o,r;if(0===this.userMap.size)return;const a=Array.from(this.userMap.values())[0].token;"string"!=typeof t&&(t=JSON.stringify(t)),s=null!==(o=s)&&void 0!==o?o:x(6,""),n=null!==(r=n)&&void 0!==r?r:this._sequence++;const c={_id:s,_type:e,_seq:n,_message:t,token:"".concat(this.token,"_").concat(a)};w("SHOW_P2P_LOG")&&v.debug("send message",c,"noNeedResponse : ".concat(i));this.splitMessage(JSON.stringify(c)).forEach((e=>{this.signal.request(Be.DATA_STREAM,{payload:_e(this.encoder.encode(e))})}));const d=new Promise(((t,n)=>{const o=window.setTimeout((()=>{this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),d),this.off(ot.ABORT,a),v.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(s)),0===this.userMap.size?n(new H(K.INVALID_REMOTE_USER)):n(new H(K.TIMEOUT))}),w("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),r=()=>{o&&window.clearTimeout(o),this.off(ot.ABORT,a),i&&t()},a=()=>{o&&window.clearTimeout(o),this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),d),n(new H(K.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(s)))};this.once(ot.ABORT,a),this.once("res-@".concat(s,"_ack"),r);const d=(i,c)=>{l=!0,o&&window.clearTimeout(o),this.off("res-@".concat(s,"_ack"),r),this.off(ot.ABORT,a),"success"===i?t(c):n(new H(K.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(s)))};let l=!1;i||(this.once("res-@".concat(s),d),he(w("SIGNAL_REQUEST_TIMEOUT")).then((()=>{l||v.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(s,", ").concat(c))})))}));try{return await d}catch(o){if(o.code===K.TIMEOUT)return await this.send(e,t,i,s,n);throw o}}onMessage(e){const{_uid:t}=e;let i,s=this.userMap.get(t);if(s)i=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==nt.CHECK)return;const{token:n}=e;i=new Map,s={uid:t,isStart:!0,token:n,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(t,s),this.signal.emit(We.ON_USER_ONLINE,{uid:t}),this.handleUserOnline()}if("id"in e&&"total"in e){var n;const{id:s,total:o}=e,r=null!==(n=i.get(s))&&void 0!==n?n:[];if(r.push(e),i.has(s)||i.set(s,r),r.length!==o)return;{const n=r.sort(((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");i.delete(s),(e=JSON.parse(n))._uid=t}}const{_type:o,token:r}=e;if([nt.ACK,nt.CHECK].includes(o))return o===nt.CHECK&&this.handleCheckToken(s,r),void this.receiveMessage(e);r==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(e):v.debug('Receive unexpected message", '.concat(r,", cur_token: ").concat(s.token,"_").concat(this.token),e)}check(){const e={_id:x(6,""),token:this.token,_type:nt.CHECK};w("SHOW_P2P_LOG")&&v.debug("send message",e),this.signal.request(Be.DATA_STREAM,{payload:_e(this.encoder.encode(JSON.stringify(e)))})}ack(e){const t={_id:e,_type:nt.ACK,token:this.token};w("SHOW_P2P_LOG")&&v.debug("send message",t),this.signal.request(Be.DATA_STREAM,{payload:_e(this.encoder.encode(JSON.stringify(t)))})}response(e,t,i){this.send(nt.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const t=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const s=t.get(i);t.delete(i),this.receiveMessage(s),e.nextExpectedSequenceNumber++}}))};if(!e)return void t();const{_uid:i,_seq:s}=e,n=this.userMap.get(i),{receivedMessagesMap:o,isStart:r,nextExpectedSequenceNumber:a}=n;if(s<a)return this.ack(e._id),void v.debug("[external-signal] receive old message, seq: ".concat(s,", ").concat(e._message));o.set(s,e),r&&s===a&&(this.receiveMessage(e),o.delete(a),n.nextExpectedSequenceNumber++,t())}receiveMessage(e){const{_id:t,_type:i,_message:s,_uid:n}=e;if(w("SHOW_P2P_LOG")&&v.debug("receive message",e),t){let o;switch(e._type!==nt.ACK&&(s&&(o=JSON.parse(s)),this.ack(e._id)),e._type){case nt.CANDIDATE:case nt.CONTROL:this.signal.emit(i,o,n);break;case nt.PUBLISH:case nt.UNPUBLISH:case nt.RESTART_ICE:case nt.CALL:o.uid=n,ce(this.signal,i,o).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case nt.ACK:this.getListeners("res-@".concat(t,"_ack")).length>0&&this.emit("res-@".concat(t,"_ack"));break;case nt.RESPONSE:{const{success:e,message:i}=o;this.emit("res-@".concat(t),e?"success":"failed",i);break}}}}splitMessage(e){if(e.length<qi.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:i}=JSON.parse(e),s=x(6,"");let n=0,o=800;const r=Math.ceil(e.length/o);for(;e.length>0;){n++;const a={id:s,index:n,total:r,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(a).length>qi.MAX_MESSAGE_SIZE?o-=50:(t.push(a),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,t){return e.token!==t?(v.debug("token changed, from ".concat(e.token," to ").concat(t)),this.reset(e.uid,t),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{v.debug("token timeout, ".concat(t)),this.reset(e.uid)}),w("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await ce(this.signal,nt.CALL,void 0),t=await this.send(nt.CALL,e);this.signal.emit(Fe.P2P_CONNECTION,t,!0)}async reset(e,t){const i=this.userMap.get(e);i&&(this.emit(ot.ABORT),this.signal.emit(We.ON_USER_OFFLINE,{uid:i.uid,reason:at.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),t||(v.debug("change local token from ".concat(t," to ").concat(t)),this.token=x(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(ot.ABORT)}}function ji(e,t){if("string"==typeof e)return e;const{proxy:i,host:s,port:n}=e;if(t){const e=w("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(s,"/ws/?p=").concat(Number(n)+150):"wss://".concat(s,":").concat(e,"/ws/?p=").concat(Number(n)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(s,"&p=").concat(n):"wss://".concat(s,":").concat(n)}qi.MAX_SIZE=1,qi.MAX_MESSAGE_SIZE=1024;const Ji=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,Xi=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,zi=/wss:\/\/(.+):([0-9]+)\/?/,Qi=/wss:\/\/(.[^\/]+)\/?/;let Zi=0;class $i{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++Zi,this.try443PortDuration=w("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;const t=Date.now()-this.startTime;for(var i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];v.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...s)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const s=w("GATEWAY_DOMAINS"),n=Date.now(),o=[],r=s.find((t=>e.host.includes(t)));r||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)s.forEach((i=>{a.push(ji(Oe(Oe({},e),{},{host:e.host.replace(r,i)}),t))}));else{const i=Oe({},e);if(t&&r){const e=s.find((e=>e!==r));e&&(i.host=i.host.replace(r,e))}a.push(ji(i,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(s){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new g(K.WS_ERR,"init websocket failed! Error: ".concat(s.toString()))}const c=Se();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-n,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-n,"ms state: ").concat(e.readyState));const s=o.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING));this.logger("".concat(t?"443":"47xx"," websocket closed, all failed: ").concat(s)),s&&(t||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:qe.A_ROUND_WS_FAILED})):!t&&s&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),l()),t?this.isTry443PortFailed=s:this.isNormalPortFailed=s},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);const d=()=>{this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))},l=()=>{if(c.isResolved)return d();me()&&M()&&d(),this.createWebSocket(e,!0,!0).then((e=>{c.resolve(e)})).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout((()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.forceCloseTimeout=null,d()}),this.forceCloseWSDuration)};return i||(()=>{if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout((()=>{this.forceCloseTimeout=null,d()}),this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{this.logger("2s timeout, isWebsocket created: ",c.isResolved),this.try443PortTimeout=null,l()}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,t,i,s){return this.useDoubleDomain=!!t,"string"==typeof e&&(e=function(e){let t,i,s;return[,t,i,s]=e.match(Ji)||[],t||([,i,s]=e.match(Xi)||[]),i&&s||([,i,s]=e.match(zi)||[]),i&&s||([,i]=e.match(Qi)||[]),i||v.warning("un-destructible url: ",e),{proxy:t,host:i,port:s||"443"}}(e)),this.recordIndex=s,this.useProxy=!!e.proxy,i&&this.useProxy&&(v.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally((()=>this.clearTimeout()))}}class es extends O{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(Ke.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Ke.CONNECTED):"closed"===this._state?this.emit(Ke.CLOSED):"failed"===this._state&&this.emit(Ke.FAILED))}resetReconnectCount(e){v.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=void 0,this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=Oe({},t),this.useCompress=i,this.tryDoubleDomain=s,this.use443PortOnly=n,this._initMutex=new G("websocket",o?o.clientId:void 0);const{timeout:r,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*r/5)),d=Math.max(1.2,Math.floor(8*a)/10);Re.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),Te.on(Ce.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===Re.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=Se(),t=this.urls[this.currentURLIndex];w("ENABLE_PREALLOC_PC")&&this.emit(st.PRE_CONNECT_PC),this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(Ke.CLOSED,(()=>{e.reject(new H(K.WS_DISCONNECT))})),this.once(Ke.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void v.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),v.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new H(K.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new H(K.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;const i=Se();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),v.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},n=async e=>{var t;if(v.debug("[".concat(this.name,"] websocket close ").concat(null===(t=this.websocket)||void 0===t?void 0:t.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new H(K.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=de(this,Ke.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,s=await this.reconnectWithAction(t);if("closed"===this.state)return void v.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return i.reject(new H(K.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);i.resolve()}},o=e=>{this.emit(Ke.ON_MESSAGE,e)},r=e=>{v.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),w("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=w("GATEWAY_WSS_ADDRESS")),v.debug("[".concat(this.name,"] start connect, url:"),e);const a=null===(t=this.store)||void 0===t?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var c;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,s&&s(this.websocket.url),this.websocket.onclose=n,this.websocket.onmessage=o,this.websocket.onerror=r,null===(c=this.store)||void 0===c||c.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this.joinGatewayRecordIndex=a}catch(e){const t="closed"===this.state,s=e instanceof H,o=s&&e.code===K.WS_ABORT,r=s&&e.code===K.WS_ERR,c=s?e.message:e&&(e.reason||e.toString());v.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(c)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:o?"aborted":"error",errors:[e]},a),t||r?(i.reject(t?new H(K.WS_DISCONNECT,"websocket is closed: ".concat(c)):new H(K.WS_ERR,"init websocket failed: ".concat(c))),r&&v.error("[".concat(this.name,"] init websocket failed: ").concat(c))):n&&n(e)}return i.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;v.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Te.isOnline||!Te.onlineWaiter||(this.onlineReconnectListener=Te.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,t){const t=pe(this.reconnectCount,this.retryConfig);v.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([he(t),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!i)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(Ke.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)await s(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);v.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await s(this.urls[this.currentURLIndex],e)}else"recover"===e&&(v.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await ce(this,Ke.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],e))}catch(i){var n;v.error("[".concat(this.name,"] reconnect failed ").concat(i&&i.toString()));const s=null==i||null===(n=i.data)||void 0===n?void 0:n.desc;return Array.isArray(s)&&s.includes("dynamic key expired")?(this.emit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class ts extends es{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){const i=Se(),s=(n=this.forceCloseTimeout,o=this.store,new $i(n,o));var n,o;this.closeEstablishingWs=()=>{v.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),i.reject(new H(K.WS_ABORT,"choose best websocket aborted"))};const r=w("GATEWAY_DOMAINS");return v.debug("[choose-best-ws] currentDomain: ",e,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class is extends O{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Ve.CONNECTED?this.emit(Fe.WS_CONNECTED):e===Ve.RECONNECTING?this.emit(Fe.WS_RECONNECTING,this._websocketReconnectReason):e===Ve.CLOSED&&this.emit(Fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=Ve.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new fe(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(Fe.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){switch(t._type){case We.ON_DATA_STREAM:return void this.handleDataStream(t._message);case We.MUTE_AUDIO:case We.MUTE_VIDEO:case We.ON_P2P_LOST:case We.ON_USER_ONLINE:return;case We.ON_USER_OFFLINE:const{uid:e}=t._message;return v.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(t._type,t._message),t._type===We.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===We.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(Ae.UID_BANNED);break;case 15:this.close(Ae.IP_BANNED);break;case 16:this.close(Ae.CHANNEL_BANNED)}if(t._type===We.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case xe.ERR_LICENSE_MISSING:this.close(Ae.LICENSE_MISSING);break;case xe.ERR_LICENSE_EXPIRED:this.close(Ae.LICENSE_EXPIRED);break;case xe.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ae.LICENSE_MINUTES_EXCEEDED);break;case xe.ERR_LICENSE_PERIOD_INVALID:this.close(Ae.LICENSE_PERIOD_INVALID);break;case xe.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ae.LICENSE_MULTIPLE_SDK_SERVICE);break;case xe.ERR_LICENSE_ILLEGAL:this.close(Ae.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new ts("gateway-".concat(this.clientId),this.spec.retryConfig,!0,w("JOIN_GATEWAY_USE_DUAL_DOMAIN"),w("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Ve.CONNECTED&&this.reconnect("retry",Ie.OFFLINE)})),this.p2pToken=x(6,""),this._external_signal=new qi(this,this.p2pToken)}async request(e,t,i,s){const n=x(6,""),o={_id:n,_type:e,_message:t},r=this.websocket.connectionID,a=()=>new Promise(((e,t)=>{if(this.connectionState===Ve.CONNECTED)return e();const i=()=>{this.off(Fe.WS_CLOSED,s),e()},s=()=>{this.off(Fe.WS_CONNECTED,i),t(new H(K.WS_ABORT))};this.once(Fe.WS_CONNECTED,i),this.once(Fe.WS_CLOSED,s)}));if(this.connectionState!==Ve.CONNECTING&&this.connectionState!==Ve.RECONNECTING||e===Be.JOIN||e===Be.REJOIN||await a(),this.websocket.sendMessage(o,!0),s)return;const c=new Promise(((i,s)=>{let o=!1;const a=(s,n)=>{o=!0,i({isSuccess:"success"===s,message:n||{}}),this.off(Fe.WS_CLOSED,c),this.off(Fe.WS_RECONNECTING,c),this.emit(Fe.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(n),a);const c=()=>{s(new H(K.WS_ABORT,"type: ".concat(e))),this.off(Fe.WS_CLOSED,c),this.off(Fe.WS_RECONNECTING,c),this.off("res-@".concat(n),a)};this.once(Fe.WS_CLOSED,c),this.once(Fe.WS_RECONNECTING,c),he(w("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||(v.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Fe.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(s){if(this.connectionState===Ve.CLOSED||e===Be.LEAVE)throw new H(K.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?s.throw():e===Be.JOIN||e===Be.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=Yi(l),u=new H(K.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message,desc:h.desc});return"success"===h.action?d.message:(v.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===xe.ERR_TOO_MANY_BROADCASTERS?e===Be.JOIN||e===Be.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===xe.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,v.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ie.MULTI_IP)):this.reconnect(h.action,Ie.SERVER_ERROR),e===Be.JOIN||e===Be.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Promise((i=>{const s=n=>{(!t||t(n))&&(this.off(e,s),i(n))};this.on(e,s)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void v.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ge.WRTC_STATS,t)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=w("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Ve.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),w("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once(Fe.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(Fe.WS_CLOSED,(()=>i(this.initError||new H(K.WS_ABORT)))),this.connectionState=Ve.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Ae.LEAVE,this.connectionState=Ve.CLOSED,v.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=x(6,""),this._external_signal.clear(),this._external_signal=new qi(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Fe.ABORT_P2P_EXECUTION);const e=await ce(this,Fe.REQUEST_JOIN_INFO),t=await this.request(Be.JOIN,e);if(!t)return this.emit(Fe.REPORT_JOIN_GATEWAY,K.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ve.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{const t=ve(e.payload),i=(new TextDecoder).decode(t),s=JSON.parse(i);"total"in s&&"id"in s||Object.values(nt).includes(s._type)?(s._uid=e.uid,this._external_signal.onMessage(s)):this.emit(We.ON_DATA_STREAM,e)}catch(t){this.emit(We.ON_DATA_STREAM,e)}}handleNotification(e){v.debug("[".concat(this.clientId,"] receive notification: "),e);const t=Yi(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(Ae.UID_BANNED),void this.close()):void this.reconnect(t.action,Ie.SERVER_ERROR);v.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=w("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(v.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>w("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Ie.TIMEOUT):this.request(Be.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),w("REPORT_STATS")&&this.send(Be.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(Ke.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(Fe.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Ke.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ke.CLOSED,(()=>{this.connectionState=Ve.CLOSED})),this.websocket.on(Ke.FAILED,(()=>{this._disconnectedReason=Ae.NETWORK_ERROR,this.connectionState=Ve.CLOSED})),this.websocket.on(Ke.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Ve.CONNECTED?this.connectionState=Ve.RECONNECTING:this.connectionState=Ve.CONNECTING})),this.websocket.on(Ke.WILL_RECONNECT,((e,t,i)=>{"retry"!==e?(v.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):v.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)})),this.websocket.on(Ke.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(Fe.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof H&&e.code===K.UNEXPECTED_RESPONSE&&e.data.code===xe.ERR_NO_AUTHORIZED)return v.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Ie.SERVER_ERROR);v.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ie.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(Ke.REQUEST_NEW_URLS,((e,t)=>{ce(this,Fe.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(We.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const ss={name:"P2PChannel",create:function(e){let{store:t,statsCollector:i}=e;return new Wi(t,i)},createSubmodule:function(e){let{store:t,spec:i}=e;return new is(i,t)}};export{ss as P2PChannelService};
